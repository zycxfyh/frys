name: frys Staging Deployment

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡æŸäº›æ£€æŸ¥)'
        required: false
        default: false
        type: boolean

jobs:
  # Staging ç¯å¢ƒéƒ¨ç½²
  staging-deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run quality checks
        run: npm run quality

      - name: Run CI tests
        run: npm run test:ci

      - name: Build application
        run: npm run build

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            frys/staging:latest
            frys/staging:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Staging ç¯å¢ƒéªŒè¯
  staging-validation:
    name: Validate Staging Deployment
    runs-on: ubuntu-latest
    needs: staging-deploy
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Wait for deployment
        run: |
          echo "ç­‰å¾…Stagingç¯å¢ƒéƒ¨ç½²å®Œæˆ..."
          sleep 30

      - name: Health check
        run: |
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„å¥åº·æ£€æŸ¥é€»è¾‘
          echo "âœ… Stagingç¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"

      - name: Run smoke tests
        run: npm run test:smoke

  # å›å½’æµ‹è¯•çŸ©é˜µ
  regression-tests:
    name: Regression Test Matrix
    runs-on: ubuntu-latest
    needs: staging-validation
    environment: staging
    strategy:
      matrix:
        test-type: ['unit', 'integration', 'e2e', 'performance', 'security']
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.test-type }} tests
        run: npm run test:${{ matrix.test-type }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: staging-${{ matrix.test-type }}-results
          path: |
            test-results/
            coverage/
            performance-results/

  # è´Ÿè½½æµ‹è¯•
  load-tests:
    name: Load Testing
    runs-on: ubuntu-latest
    needs: regression-tests
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install k6
        run: |
          curl -s https://dl.k6.io/key.asc | sudo apt-key add -
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load tests
        run: |
          # åˆ›å»ºç®€å•çš„è´Ÿè½½æµ‹è¯•è„šæœ¬
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            stages: [
              { duration: '30s', target: 10 },  // æ¨¡æ‹Ÿ10ä¸ªç”¨æˆ·
              { duration: '1m', target: 50 },   // é€æ­¥å¢åŠ åˆ°50ä¸ªç”¨æˆ·
              { duration: '30s', target: 0 },  // é€æ­¥å‡å°‘
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'], // 95%çš„è¯·æ±‚åœ¨500mså†…å®Œæˆ
              http_req_failed: ['rate<0.1'],    // é”™è¯¯ç‡å°äº10%
            },
          };

          export default function () {
            const response = http.get('http://staging.frys.com/health');
            check(response, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });
            sleep(1);
          }
          EOF

          k6 run load-test.js

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            load-test-results/

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: staging-validation
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://staging.frys.com'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'

  # æ€§èƒ½ç›‘æ§
  performance-monitoring:
    name: Performance Monitoring
    runs-on: ubuntu-latest
    needs: [regression-tests, load-tests]
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Generate performance report
        run: |
          echo "ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š..."
          # è¿™é‡Œå¯ä»¥æ·»åŠ æ€§èƒ½åˆ†æé€»è¾‘
          echo "âœ… æ€§èƒ½ç›‘æ§å®Œæˆ"

      - name: Upload performance metrics
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: |
            performance-metrics/

  # éƒ¨ç½²éªŒè¯å’Œé€šçŸ¥
  deployment-verification:
    name: Deployment Verification
    runs-on: ubuntu-latest
    needs: [regression-tests, load-tests, security-scan, performance-monitoring]
    environment: staging
    if: always()
    steps:
      - name: Verify deployment status
        run: |
          echo "éªŒè¯éƒ¨ç½²çŠ¶æ€..."
          # æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ä½œä¸šæ˜¯å¦æˆåŠŸ
          if [ "${{ needs.regression-tests.result }}" != "success" ]; then
            echo "âŒ å›å½’æµ‹è¯•å¤±è´¥"
            exit 1
          fi

          if [ "${{ needs.load-tests.result }}" != "success" ]; then
            echo "âŒ è´Ÿè½½æµ‹è¯•å¤±è´¥"
            exit 1
          fi

          if [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "âŒ å®‰å…¨æ‰«æå¤±è´¥"
            exit 1
          fi

          echo "âœ… Stagingéƒ¨ç½²éªŒè¯é€šè¿‡"

      - name: Send deployment notification
        run: |
          echo "å‘é€éƒ¨ç½²é€šçŸ¥..."
          # è¿™é‡Œå¯ä»¥é›†æˆSlackã€Teamsæˆ–å…¶ä»–é€šçŸ¥æœåŠ¡
          echo "ğŸš€ frys Stagingç¯å¢ƒéƒ¨ç½²æˆåŠŸï¼"

      - name: Create deployment summary
        run: |
          echo "## ğŸš€ Stagingéƒ¨ç½²æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… éƒ¨ç½²çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¯å¢ƒ**: Staging" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ§ª æµ‹è¯•ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "- **å•å…ƒæµ‹è¯•**: ${{ needs.regression-tests.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é›†æˆæµ‹è¯•**: ${{ needs.regression-tests.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **è´Ÿè½½æµ‹è¯•**: ${{ needs.load-tests.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å®‰å…¨æ‰«æ**: ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— è®¿é—®åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨**: http://staging.frys.com" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›‘æ§**: http://staging.frys.com:9090" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¥å¿—**: [æŸ¥çœ‹è¯¦æƒ…](#)" >> $GITHUB_STEP_SUMMARY

  # å›æ»šå‡†å¤‡
  rollback-preparation:
    name: Rollback Preparation
    runs-on: ubuntu-latest
    needs: deployment-verification
    environment: staging
    if: failure()
    steps:
      - name: Prepare rollback
        run: |
          echo "å‡†å¤‡å›æ»šç­–ç•¥..."
          # ä¿å­˜å½“å‰éƒ¨ç½²çŠ¶æ€ï¼Œç”¨äºå›æ»š
          echo "âœ… å›æ»šå‡†å¤‡å®Œæˆ"

      - name: Send rollback alert
        run: |
          echo "å‘é€å›æ»šè­¦æŠ¥..."
          echo "âš ï¸ Stagingç¯å¢ƒéƒ¨ç½²å¤±è´¥ï¼Œå‡†å¤‡å›æ»š"
