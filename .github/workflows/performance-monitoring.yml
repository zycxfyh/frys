name: ğŸ“Š æ€§èƒ½ç›‘æ§

# æ€§èƒ½ç›‘æ§è§¦å‘æ¡ä»¶
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹è¿›è¡Œæ€§èƒ½ç›‘æ§
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'ç›‘æ§ç¯å¢ƒ'
        required: false
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      duration:
        description: 'ç›‘æ§æŒç»­æ—¶é—´(ç§’)'
        required: false
        type: number
        default: 300

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # æ€§èƒ½åŸºå‡†æµ‹è¯•
  performance-baseline:
    name: 'æ€§èƒ½åŸºå‡†æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
      run: npm run build

    - name: âš¡ å•å…ƒæµ‹è¯•æ€§èƒ½
      run: |
        echo "è¿è¡Œå•å…ƒæµ‹è¯•æ€§èƒ½åˆ†æ..."
        npm run test:unit -- --reporter=verbose --coverage --profile
      continue-on-error: true

    - name: ğŸ”¬ å†…å­˜æ³„æ¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥å†…å­˜æ³„æ¼..."
        node --expose-gc --max-old-space-size=256 scripts/memory-leak-test.js
      continue-on-error: true

    - name: ğŸ“Š Lighthouse æ€§èƒ½å®¡è®¡
      uses: treosh/lighthouse-ci-action@v10
      with:
        urls: |
          http://localhost:3000
        configPath: .lighthouserc.json
        uploadArtifacts: true
        temporaryPublicStorage: true
      continue-on-error: true

    - name: ğŸ·ï¸ ä¸Šä¼ æ€§èƒ½åŸºå‡†ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-baseline-results
        path: |
          .lighthouseci/
          performance-report.json
        retention-days: 30

  # è´Ÿè½½æµ‹è¯•
  load-testing:
    name: 'è´Ÿè½½æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ—ï¸ æ„å»ºå’Œå¯åŠ¨åº”ç”¨
      run: |
        npm run build
        npm start &
        sleep 30

    - name: ğŸš€ å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
      run: |
        docker-compose -f docker-compose.staging.yml up -d --build
        timeout 180 bash -c 'until curl -f http://localhost:3000/health; do sleep 5; done'

    - name: ğŸ“ˆ Artillery è´Ÿè½½æµ‹è¯•
      uses: artilleryio/action-cli@v1
      with:
        command: run --output load-test-results.json scripts/load-test.yml
      continue-on-error: true

    - name: ğŸ”„ å‹åŠ›æµ‹è¯•
      run: node scripts/load-generator.js http://localhost:3000 --stress --duration 60
      continue-on-error: true

    - name: ğŸ“Š k6 æ€§èƒ½æµ‹è¯•
      uses: k6io/action@v0.1.0
      with:
        filename: scripts/k6-performance-test.js
        flags: --out json=k6-results.json
      continue-on-error: true

    - name: ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ
      if: always()
        run: docker-compose -f docker-compose.staging.yml down -v

    - name: ğŸ·ï¸ ä¸Šä¼ è´Ÿè½½æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: load-testing-results
        path: |
          load-test-results.json
          k6-results.json
          stress-test-report.json
        retention-days: 30

  # SLO ç›‘æ§
  slo-monitoring:
    name: 'SLO ç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ“Š SLO æ£€æŸ¥
      run: node scripts/slo-check.js
      env:
        PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}
        GRAFANA_URL: ${{ secrets.GRAFANA_URL }}

    - name: ğŸ¯ é”™è¯¯é¢„ç®—ç›‘æ§
      run: |
        echo "æ£€æŸ¥é”™è¯¯é¢„ç®—ä½¿ç”¨æƒ…å†µ..."
        # è¿™é‡Œå¯ä»¥é›†æˆé”™è¯¯é¢„ç®—ç›‘æ§é€»è¾‘

    - name: ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡æ”¶é›†
      run: |
        echo "æ”¶é›†æ€§èƒ½æŒ‡æ ‡..."
        # æ”¶é›†å“åº”æ—¶é—´ã€ååé‡ã€èµ„æºä½¿ç”¨ç­‰æŒ‡æ ‡

    - name: ğŸ·ï¸ ä¸Šä¼  SLO ç›‘æ§ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: slo-monitoring-results
        path: |
          slo-check-report.json
          slo-baseline.json
        retention-days: 30

  # ç”Ÿäº§ç¯å¢ƒç›‘æ§
  production-monitoring:
    name: 'ç”Ÿäº§ç¯å¢ƒç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
    environment: production

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ‘€ å®æ—¶ç›‘æ§æ£€æŸ¥
      run: node scripts/performance-monitor.js --live --duration ${{ inputs.duration || 300 }}
      env:
        PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        MONITORING_API_KEY: ${{ secrets.MONITORING_API_KEY }}

    - name: ğŸ“Š APM æ•°æ®æ”¶é›†
      run: |
        echo "æ”¶é›† APM æ•°æ®..."
        # é›†æˆ New Relic, DataDog ç­‰ APM å·¥å…·

    - name: ğŸš¨ å¼‚å¸¸æ£€æµ‹
      run: |
        echo "è¿è¡Œå¼‚å¸¸æ£€æµ‹ç®—æ³•..."
        # æ£€æµ‹æ€§èƒ½å¼‚å¸¸å’Œè¶‹åŠ¿å˜åŒ–

    - name: ğŸ“¢ æ€§èƒ½è­¦æŠ¥
      if: failure()
      run: |
        echo "ğŸš¨ æ£€æµ‹åˆ°æ€§èƒ½é—®é¢˜ï¼"
        # å‘é€è­¦æŠ¥åˆ°ç›¸å…³å›¢é˜Ÿ

    - name: ğŸ·ï¸ ä¸Šä¼ ç”Ÿäº§ç›‘æ§ç»“æœ
      uses: actions/upload-artifact@v4
      with:
        name: production-monitoring-results
        path: |
          production-performance-report.json
          anomaly-detection-results.json
        retention-days: 30

  # æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ
  performance-report:
    name: 'æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [performance-baseline, load-testing, slo-monitoring]
    if: always()

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ“Š ç”Ÿæˆç»¼åˆæ€§èƒ½æŠ¥å‘Š
      run: node scripts/performance-monitor.js --report --comprehensive
      env:
        CI: true

    - name: ğŸ“ˆ æ€§èƒ½è¶‹åŠ¿åˆ†æ
      run: node scripts/coverage-trend-analyzer.js --performance
      continue-on-error: true

    - name: ğŸ“‹ æ€§èƒ½æ‘˜è¦
      run: |
        echo "# ğŸ“Š æ€§èƒ½ç›‘æ§æŠ¥å‘Š" > performance-summary.md
        echo "" >> performance-summary.md
        echo "## æµ‹è¯•æ—¶é—´" >> performance-summary.md
        echo "$(date)" >> performance-summary.md
        echo "" >> performance-summary.md
        echo "## æ€§èƒ½æŒ‡æ ‡" >> performance-summary.md

        # ä»å„ä¸ªæµ‹è¯•ç»“æœä¸­æå–å…³é”®æŒ‡æ ‡
        echo "- åŸºå‡†æµ‹è¯•: âœ… å·²å®Œæˆ" >> performance-summary.md
        echo "- è´Ÿè½½æµ‹è¯•: âœ… å·²å®Œæˆ" >> performance-summary.md
        echo "- SLO ç›‘æ§: âœ… å·²å®Œæˆ" >> performance-summary.md
        echo "" >> performance-summary.md
        echo "## è¯¦ç»†æŠ¥å‘Š" >> performance-summary.md
        echo "è¯·æŸ¥çœ‹é™„ä»¶ä¸­çš„è¯¦ç»†æ€§èƒ½æµ‹è¯•ç»“æœã€‚" >> performance-summary.md

    - name: ğŸ·ï¸ ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: performance-report
        path: |
          performance-report.json
          performance-summary.md
          performance-trend-report.json
        retention-days: 30

    - name: ğŸš¨ æ€§èƒ½é˜ˆå€¼æ£€æŸ¥
      run: |
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡æ€§èƒ½é˜ˆå€¼
        if [ -f "performance-report.json" ]; then
          response_time=$(jq '.metrics.responseTime.avg' performance-report.json 2>/dev/null || echo "0")
          if (( $(echo "$response_time > 1000" | bc -l 2>/dev/null || echo "0") )); then
            echo "âš ï¸ å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼: ${response_time}ms"
          fi
        fi
