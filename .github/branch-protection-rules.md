# 🛡️ 分支保护规则配置

## 规则概述

WokeFlow 项目采用严格的分支保护策略，确保代码质量和安全性。

## 主分支保护规则 (main/develop)

### 🔒 必需条件

#### 状态检查 (Required Status Checks)
必须通过以下所有检查才能合并：

1. **Code Quality Check**
   - ESLint 检查通过
   - Prettier 格式化检查通过

2. **Unit Tests**
   - Node.js 18 单元测试通过
   - Node.js 20 单元测试通过

3. **Integration Tests**
   - 所有集成测试通过
   - Redis 服务可用

4. **Performance Tests**
   - 性能基准测试通过
   - 内存泄漏检查通过

5. **E2E Tests**
   - 端到端测试通过
   - UI 交互正常

6. **Security Tests**
   - 安全测试通过
   - npm audit 无高危漏洞

7. **Coverage Report**
   - 测试覆盖率 >= 80%
   - Codecov 报告生成成功

8. **Quality Gate**
   - 所有质量门禁通过

#### 代码审查要求 (Required Reviews)

- **最少审查者**: 2人
- **包括代码所有者**: 是
- **需要管理员批准**: 否 (但推荐)

#### 其他限制

- **需要最新提交**: 是
- **需要线性历史**: 是
- **允许强制推送**: 否
- **允许删除**: 否
- **限制合并**: 仅允许 Squash and merge

## 功能分支保护规则 (feature/*)

### 🔒 必需条件

#### 状态检查
- Code Quality Check ✅
- Unit Tests ✅
- Integration Tests ✅ (可选)

#### 代码审查要求
- 最少审查者: 1人
- 包括代码所有者: 否

## 补丁分支保护规则 (hotfix/*)

### 🚨 紧急修复规则

#### 状态检查
- Code Quality Check ✅
- Unit Tests ✅
- Security Tests ✅

#### 代码审查要求
- 最少审查者: 2人 (紧急情况下可降至1人)
- 需要管理员批准: 是

#### 其他限制
- 允许强制推送: 仅限管理员
- 合并时间限制: 24小时内必须合并

## 发布分支保护规则 (release/*)

### 📦 发布准备规则

#### 状态检查
- 所有测试类型 ✅
- Coverage Report ✅
- Security Audit ✅

#### 代码审查要求
- 最少审查者: 3人
- 包括产品经理: 是

## 实施指南

### 配置步骤

1. **GitHub 设置**
   ```
   Settings → Branches → Add rule
   Branch name pattern: main, develop
   ```

2. **状态检查配置**
   - 确保所有 GitHub Actions workflow 正确配置
   - 检查 webhook 配置是否正确

3. **团队培训**
   - 向团队成员解释分支保护规则
   - 培训如何处理失败的检查

### 例外处理

#### 紧急情况处理流程

1. **评估紧急程度**
   - 确定是否为真正的紧急情况
   - 评估风险和影响

2. **临时规则调整**
   - 管理员临时降低要求
   - 记录调整原因和时间

3. **事后审查**
   - 紧急合并后进行代码审查
   - 分析改进空间

#### 常见例外场景

- **零停机部署**: 允许跳过某些测试
- **安全补丁**: 可加速审查流程
- **基础设施修复**: 可临时调整规则

## 监控和维护

### 🔍 规则合规性检查

- **定期审计**: 每月检查分支保护规则执行情况
- **自动化监控**: 使用 GitHub API 监控规则变化
- **团队反馈**: 收集开发者的使用反馈

### 📊 指标跟踪

| 指标 | 目标值 | 当前值 | 状态 |
|-----|--------|--------|------|
| PR 平均审查时间 | < 24h | - | 📊 |
| 质量门禁阻挡率 | > 95% | - | 📊 |
| 紧急绕过次数 | < 5次/月 | - | 📊 |

## 最佳实践

### ✅ 推荐做法

1. **小批量提交**: 保持PR规模适中
2. **清晰描述**: 详细填写PR模板
3. **提前沟通**: 与审查者提前讨论变更
4. **自测充分**: 提交前完成全面测试

### ❌ 避免做法

1. **大PR**: 避免超过500行代码的PR
2. **紧急绕过**: 除非真正紧急，否则遵守规则
3. **跳过测试**: 不要为了速度而跳过必要检查
4. **强制推送**: 除非有充分理由，否则不使用

---

*此配置由 WokeFlow 工业级开发流程生成*
