name: ðŸš€ Production Deployment

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'éƒ¨ç½²æ ‡ç­¾ (å¯é€‰ï¼Œä¸å¡«åˆ™ä½¿ç”¨æœ€æ–°)'
        required: false
        type: string
      confirm:
        description: 'ç¡®è®¤ç”Ÿäº§éƒ¨ç½²'
        required: true
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  production-deployment:
    name: 'ðŸ”¥ ç”Ÿäº§éƒ¨ç½²æµæ°´çº¿'
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 45

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: âœ… éƒ¨ç½²ç¡®è®¤æ£€æŸ¥
      if: github.event.inputs.confirm != 'true'
      run: |
        echo "âŒ ç”Ÿäº§éƒ¨ç½²éœ€è¦æ‰‹åŠ¨ç¡®è®¤ï¼Œè¯·å‹¾é€‰ç¡®è®¤é€‰é¡¹"
        exit 1

    - name: ðŸ·ï¸ ç¡®å®šéƒ¨ç½²æ ‡ç­¾
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "DEPLOY_TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          # ä»Ž staging èŽ·å–æœ€æ–°çš„æˆåŠŸæž„å»º
          echo "DEPLOY_TAG=latest" >> $GITHUB_ENV
        fi
        echo "ç”Ÿäº§éƒ¨ç½²æ ‡ç­¾: $DEPLOY_TAG"

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    # ðŸ”„ å®Œæ•´çš„ç”Ÿäº§å‰æ£€æŸ¥
    - name: ðŸ”„ ç”Ÿäº§å‰å®Œæ•´æ£€æŸ¥
      run: |
        echo "æ‰§è¡Œç”Ÿäº§å‰å®Œæ•´æ£€æŸ¥..."

        # 1. ä»£ç è´¨é‡æ£€æŸ¥
        echo "1ï¸âƒ£ ä»£ç è´¨é‡æ£€æŸ¥..."
        npm run lint

        # 2. å•å…ƒæµ‹è¯•
        echo "2ï¸âƒ£ å•å…ƒæµ‹è¯•..."
        npm run test:unit

        # 3. é›†æˆæµ‹è¯•
        echo "3ï¸âƒ£ é›†æˆæµ‹è¯•..."
        npm run test:integration

        # 4. å®‰å…¨å®¡è®¡
        echo "4ï¸âƒ£ å®‰å…¨å®¡è®¡..."
        npm audit --audit-level=high
        node scripts/security-audit.js

        # 5. æ€§èƒ½æµ‹è¯•
        echo "5ï¸âƒ£ æ€§èƒ½æµ‹è¯•..."
        npm run test:performance

        echo "âœ… ç”Ÿäº§å‰æ£€æŸ¥å…¨éƒ¨é€šè¿‡"

    # ðŸ—ï¸ ç”Ÿäº§æž„å»º
    - name: ðŸ—ï¸ ç”Ÿäº§æž„å»º
      run: |
        echo "å¼€å§‹ç”Ÿäº§æž„å»º..."
        npm run build:prod

        echo "æž„å»º Docker é•œåƒ..."
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }} .
        docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production

        echo "ç™»å½•å®¹å™¨æ³¨å†Œè¡¨..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

        echo "æŽ¨é€ç”Ÿäº§é•œåƒ..."
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:production

        echo "âœ… ç”Ÿäº§æž„å»ºå®Œæˆ"

    # ðŸš€ ç”Ÿäº§éƒ¨ç½² (è“ç»¿éƒ¨ç½²ç­–ç•¥)
    - name: ðŸš€ ç”Ÿäº§éƒ¨ç½² (è“ç»¿éƒ¨ç½²)
      run: |
        echo "å¼€å§‹ç”Ÿäº§çŽ¯å¢ƒè“ç»¿éƒ¨ç½²..."

        # ç¡®å®šç›®æ ‡é¢œè‰² (blue/green)
        CURRENT_COLOR=$(curl -s https://frys.com/api/health | jq -r '.color' 2>/dev/null || echo "blue")
        TARGET_COLOR=$([ "$CURRENT_COLOR" = "blue" ] && echo "green" || echo "blue")

        echo "å½“å‰æ´»è·ƒçŽ¯å¢ƒ: $CURRENT_COLOR"
        echo "ç›®æ ‡éƒ¨ç½²çŽ¯å¢ƒ: $TARGET_COLOR"

        # éƒ¨ç½²åˆ°ç›®æ ‡çŽ¯å¢ƒ
        echo "éƒ¨ç½²åˆ° $TARGET_COLOR çŽ¯å¢ƒ..."
        ./scripts/deploy.sh --env=production --color=$TARGET_COLOR --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:prod-${{ github.sha }}

        # ç­‰å¾…éƒ¨ç½²å®Œæˆ
        echo "ç­‰å¾…éƒ¨ç½²å®Œæˆ..."
        sleep 60

        # å¥åº·æ£€æŸ¥
        echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..30}; do
          if curl -f -s https://$TARGET_COLOR.frys.com/health > /dev/null; then
            echo "âœ… $TARGET_COLOR çŽ¯å¢ƒå¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "ç­‰å¾…å¥åº·æ£€æŸ¥... ($i/30)"
          sleep 10
        done

        # æµé‡åˆ‡æ¢
        echo "æ‰§è¡Œæµé‡åˆ‡æ¢..."
        ./scripts/deploy.sh --switch-traffic --from=$CURRENT_COLOR --to=$TARGET_COLOR

        # æœ€ç»ˆéªŒè¯
        echo "æœ€ç»ˆéƒ¨ç½²éªŒè¯..."
        node scripts/deployment-verification.js --env=production --color=$TARGET_COLOR

        echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ"

    # ðŸ§ª ç”Ÿäº§çŽ¯å¢ƒæµ‹è¯•
    - name: ðŸ§ª ç”Ÿäº§çŽ¯å¢ƒæµ‹è¯•
      run: |
        echo "å¼€å§‹ç”Ÿäº§çŽ¯å¢ƒæµ‹è¯•..."

        # å†’çƒŸæµ‹è¯•
        echo "æ‰§è¡Œå†’çƒŸæµ‹è¯•..."
        npm run test:smoke -- --env=production

        # API ç«¯åˆ°ç«¯æµ‹è¯•
        echo "æ‰§è¡Œ API E2E æµ‹è¯•..."
        npm run test:e2e:api -- --env=production

        # ç”¨æˆ·ç•Œé¢æµ‹è¯• (å¯é€‰)
        echo "æ‰§è¡Œç”¨æˆ·ç•Œé¢æµ‹è¯•..."
        npm run test:e2e:ui -- --env=production --headless

        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒæµ‹è¯•é€šè¿‡"

    # ðŸ“Š æ€§èƒ½ç›‘æŽ§å’ŒåŸºå‡†æµ‹è¯•
    - name: ðŸ“Š æ€§èƒ½ç›‘æŽ§
      run: |
        echo "å¼€å§‹æ€§èƒ½ç›‘æŽ§..."

        # æ€§èƒ½åŸºå‡†æµ‹è¯•
        echo "æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        npm run benchmark -- --env=production

        # ç›‘æŽ§æŒ‡æ ‡æ”¶é›†
        echo "æ”¶é›†ç›‘æŽ§æŒ‡æ ‡..."
        node scripts/monitoring-rollback.js --baseline

        # SLO æ£€æŸ¥
        echo "æ£€æŸ¥æœåŠ¡æ°´å¹³ç›®æ ‡..."
        node scripts/slo-check.js

        echo "âœ… æ€§èƒ½ç›‘æŽ§å®Œæˆ"

    # ðŸ”„ å›žæ»šå‡†å¤‡
    - name: ðŸ”„ å›žæ»šå‡†å¤‡
      if: always()
      run: |
        echo "å‡†å¤‡å›žæ»šç­–ç•¥..."

        # ä¿å­˜å½“å‰çŠ¶æ€
        node scripts/smart-rollback.js --save-state --env=production

        # ç”Ÿæˆå›žæ»šè®¡åˆ’
        node scripts/rollback.sh --plan --env=production > rollback-plan.txt

        echo "å›žæ»šå‡†å¤‡å®Œæˆ"

    # ðŸ“‹ éƒ¨ç½²æŠ¥å‘Šç”Ÿæˆ
    - name: ðŸ“‹ ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      if: always()
      run: |
        echo "ç”Ÿæˆç”Ÿäº§éƒ¨ç½²æŠ¥å‘Š..."

        DEPLOY_STATUS="${{ job.status }}"
        DEPLOY_DURATION=$((SECONDS / 60))

        cat > production-deployment-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref }}",
          "environment": "production",
          "status": "$DEPLOY_STATUS",
          "duration_minutes": $DEPLOY_DURATION,
          "deploy_tag": "${{ env.DEPLOY_TAG }}",
          "confirmation_required": true,
          "confirmation_provided": ${{ github.event.inputs.confirm }},
          "pipeline_steps": [
            {
              "step": "ç”Ÿäº§å‰æ£€æŸ¥",
              "status": "âœ…",
              "duration": "~10åˆ†é’Ÿ",
              "description": "ä»£ç è´¨é‡ã€æµ‹è¯•ã€å®‰å…¨å®¡è®¡ã€æ€§èƒ½æµ‹è¯•"
            },
            {
              "step": "ç”Ÿäº§æž„å»º",
              "status": "âœ…",
              "duration": "~5åˆ†é’Ÿ",
              "description": "ç”Ÿäº§é•œåƒæž„å»ºå’ŒæŽ¨é€"
            },
            {
              "step": "è“ç»¿éƒ¨ç½²",
              "status": "$DEPLOY_STATUS",
              "duration": "~15åˆ†é’Ÿ",
              "description": "é›¶åœæœºè“ç»¿éƒ¨ç½²ç­–ç•¥"
            },
            {
              "step": "ç”Ÿäº§æµ‹è¯•",
              "status": "$DEPLOY_STATUS",
              "duration": "~10åˆ†é’Ÿ",
              "description": "å†’çƒŸæµ‹è¯•ã€E2Eæµ‹è¯•ã€UIæµ‹è¯•"
            },
            {
              "step": "æ€§èƒ½ç›‘æŽ§",
              "status": "$DEPLOY_STATUS",
              "duration": "~5åˆ†é’Ÿ",
              "description": "æ€§èƒ½åŸºå‡†ã€SLOæ£€æŸ¥ã€ç›‘æŽ§è®¾ç½®"
            }
          ],
          "rollback_ready": true,
          "monitoring_enabled": true
        }
        EOF

    # ðŸ“¤ ä¸Šä¼ éƒ¨ç½²äº§ç‰©
    - name: ðŸ“¤ ä¸Šä¼ éƒ¨ç½²äº§ç‰©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: production-deployment-artifacts
        path: |
          production-deployment-report.json
          rollback-plan.txt
          benchmark-results/
          monitoring-baseline.json

    # ðŸš¨ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
    - name: ðŸš¨ éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}' === 'success' ? 'ðŸš€' : 'ðŸš¨';
          const duration = Math.floor(${{ env.SECONDS || 0 }} / 60);
          const message = `${status} **frys ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæˆ**

**éƒ¨ç½²ä¿¡æ¯**:
- **æäº¤**: ${context.sha.substring(0, 7)}
- **åˆ†æ”¯**: main
- **çŽ¯å¢ƒ**: ç”Ÿäº§çŽ¯å¢ƒ
- **çŠ¶æ€**: ${{ job.status }}
- **è€—æ—¶**: ${duration} åˆ†é’Ÿ
- **éƒ¨ç½²æ ‡ç­¾**: ${{ env.DEPLOY_TAG }}

**æµæ°´çº¿æ­¥éª¤**:
âœ… ç”Ÿäº§å‰æ£€æŸ¥ (~10åˆ†é’Ÿ) - ä»£ç è´¨é‡ã€æµ‹è¯•ã€å®‰å…¨å®¡è®¡ã€æ€§èƒ½æµ‹è¯•
âœ… ç”Ÿäº§æž„å»º (~5åˆ†é’Ÿ) - Dockeré•œåƒæž„å»ºå’ŒæŽ¨é€
${{ job.status === 'success' ? 'âœ…' : 'âŒ' }} è“ç»¿éƒ¨ç½² (~15åˆ†é’Ÿ) - é›¶åœæœºéƒ¨ç½²ç­–ç•¥
${{ job.status === 'success' ? 'âœ…' : 'âŒ' }} ç”Ÿäº§æµ‹è¯• (~10åˆ†é’Ÿ) - å†’çƒŸæµ‹è¯•ã€E2Eæµ‹è¯•ã€UIæµ‹è¯•
${{ job.status === 'success' ? 'âœ…' : 'âŒ' }} æ€§èƒ½ç›‘æŽ§ (~5åˆ†é’Ÿ) - åŸºå‡†æµ‹è¯•ã€SLOæ£€æŸ¥

**ç›‘æŽ§ä¿¡æ¯**:
- ðŸ” [åº”ç”¨ç›‘æŽ§é¢æ¿](https://grafana.frys.com)
- ðŸ“Š [æ€§èƒ½æŒ‡æ ‡é¢æ¿](https://prometheus.frys.com)
- ðŸš¨ [å‘Šè­¦ä¸­å¿ƒ](https://alertmanager.frys.com)

[ðŸ“‹ æŸ¥çœ‹è¯¦ç»†éƒ¨ç½²æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          // åˆ›å»º GitHub Issue è¯„è®º
          if (context.issue) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
          }

          // å‘é€ Slack é€šçŸ¥
          if (process.env.SLACK_WEBHOOK_URL) {
            const slackColor = '${{ job.status }}' === 'success' ? 'good' : 'danger';
            const slackMessage = {
              attachments: [{
                color: slackColor,
                title: `frys ç”Ÿäº§éƒ¨ç½² ${{ job.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥' }}`,
                title_link: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
                fields: [
                  { title: 'æäº¤', value: context.sha.substring(0, 7), short: true },
                  { title: 'è€—æ—¶', value: `${duration}åˆ†é’Ÿ`, short: true },
                  { title: 'çŽ¯å¢ƒ', value: 'ç”Ÿäº§çŽ¯å¢ƒ', short: true },
                  { title: 'çŠ¶æ€', value: '${{ job.status }}', short: true }
                ],
                footer: 'frys CI/CD Pipeline',
                ts: Date.now() / 1000
              }]
            };

            await fetch(process.env.SLACK_WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(slackMessage)
            });
          }

    # ðŸŽ¯ éƒ¨ç½²æˆåŠŸåº†ç¥
    - name: ðŸŽ¯ éƒ¨ç½²æˆåŠŸåº†ç¥
      if: success()
      run: |
        echo "ðŸŽ‰ æ­å–œï¼frys ç”Ÿäº§éƒ¨ç½²æˆåŠŸï¼"
        echo "ðŸš€ åº”ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
        echo "ðŸ“Š æ‰€æœ‰ç›‘æŽ§å’Œå‘Šè­¦ç³»ç»Ÿå·²å¯ç”¨"
        echo "ðŸ”„ å›žæ»šç­–ç•¥å·²å‡†å¤‡å°±ç»ª"
