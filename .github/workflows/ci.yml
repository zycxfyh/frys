name: ğŸš€ frys CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 1ï¸âƒ£ æœ¬åœ°éªŒè¯ - ä¾èµ–å®‰è£…å’Œç¯å¢ƒæ£€æŸ¥
  validate:
    name: '1ï¸âƒ£ æœ¬åœ°éªŒè¯'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm ci
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

    - name: ğŸ” ç¯å¢ƒæ£€æŸ¥
      run: |
        node --version
        npm --version
        echo "Node.js ç‰ˆæœ¬: $(node --version)"
        echo "NPM ç‰ˆæœ¬: $(npm --version)"
        echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡"

    - name: ğŸ“‹ é¡¹ç›®ç»“æ„éªŒè¯
      run: |
        ls -la
        echo "âœ… é¡¹ç›®ç»“æ„å®Œæ•´"

  # 2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯• - ESLint + å•å…ƒæµ‹è¯•
  test:
    name: '2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ” ESLint ä»£ç æ£€æŸ¥
      run: |
        npm run lint
        echo "âœ… ESLint æ£€æŸ¥é€šè¿‡"

    - name: ğŸ§ª å•å…ƒæµ‹è¯•
      run: |
        npm run test:unit
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

    - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-unit
        path: |
          test-results/
          coverage/

  # 3ï¸âƒ£ å®‰å…¨æ£€æŸ¥ - npm audit + å®‰å…¨æ‰«æ
  security:
    name: '3ï¸âƒ£ å®‰å…¨æ£€æŸ¥'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: validate

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ”’ NPM å®‰å…¨å®¡è®¡
      run: |
        npm audit --audit-level=moderate
        echo "âœ… NPM å®‰å…¨å®¡è®¡é€šè¿‡"

    - name: ğŸ›¡ï¸ å·¥ä¸šçº§å®‰å…¨æ‰«æ
      run: |
        node scripts/security-audit.js
        echo "âœ… å·¥ä¸šçº§å®‰å…¨æ‰«æé€šè¿‡"

    - name: ğŸ“‹ å®‰å…¨æŠ¥å‘Š
      run: |
        if [ -f security-audit-report.json ]; then
          echo "å®‰å…¨æ‰«ææŠ¥å‘Šå·²ç”Ÿæˆ"
          cat security-audit-report.json | jq '.summary'
        fi

  # 4ï¸âƒ£ é›†æˆæµ‹è¯• - å¤šç»„ä»¶åä½œæµ‹è¯•
  integration:
    name: '4ï¸âƒ£ é›†æˆæµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test, security]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ³ è®¾ç½® Testcontainers
      run: |
        echo "Setting up test environment..."
        docker --version

    - name: ğŸ”— é›†æˆæµ‹è¯•
      run: |
        npm run test:integration
        echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"
      env:
        REDIS_URL: redis://localhost:6379
        NODE_ENV: test

    - name: ğŸ“Š ä¸Šä¼ é›†æˆæµ‹è¯•ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-integration
        path: |
          test-results/
          integration-test-reports/

  # 5ï¸âƒ£ PRå®¡æ ¸ - è‡ªåŠ¨ä»£ç å®¡æŸ¥
  pr-review:
    name: '5ï¸âƒ£ PRå®¡æ ¸'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request'
    needs: [test, security]

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        node scripts/pr-check.js
        echo "âœ… PR ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"

    - name: ğŸ“‹ PR å®¡æŸ¥æŠ¥å‘Š
      run: |
        if [ -f pr-check-report.json ]; then
          echo "PR å®¡æŸ¥æŠ¥å‘Š:"
          cat pr-check-report.json | jq '.summary'
        fi

    - name: ğŸ’¬ è¯„è®º PR
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('pr-check-report.json')) {
            const report = JSON.parse(fs.readFileSync('pr-check-report.json', 'utf8'));
            const comment = `## ğŸ” PR è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š

**çŠ¶æ€**: ${report.summary.status === 'PASSED' ? 'âœ… é€šè¿‡' : 'âŒ éœ€è¦ä¿®æ”¹'}

### ğŸ“Š æ£€æŸ¥ç»“æœ
- **ä»£ç è´¨é‡**: ${report.quality.score}/100
- **æµ‹è¯•è¦†ç›–ç‡**: ${report.coverage.percentage}%
- **å®‰å…¨é—®é¢˜**: ${report.security.issues.length}

### ğŸ“ å»ºè®®
${report.recommendations.map(r => `- ${r}`).join('\n')}

[æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  # 6ï¸âƒ£ æ„å»ºå’Œæ‰“åŒ…
  build:
    name: 'ğŸ—ï¸ æ„å»ºæ‰“åŒ…'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [validate, test, security, integration]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ—ï¸ ç”Ÿäº§æ„å»º
      run: |
        npm run build
        echo "âœ… ç”Ÿäº§æ„å»ºå®Œæˆ"

    - name: ğŸ³ æ„å»º Docker é•œåƒ
      run: |
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
        echo "âœ… Docker é•œåƒæ„å»ºå®Œæˆ"

    - name: ğŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¤ æ¨é€ Docker é•œåƒ
      run: |
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
        echo "âœ… Docker é•œåƒæ¨é€å®Œæˆ"

    - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts
        path: |
          dist/
          docker-compose*.yml
          Dockerfile

  # 7ï¸âƒ£ Staging éƒ¨ç½²
  staging-deploy:
    name: '6ï¸âƒ£ Stagingéƒ¨ç½²'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: staging

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: ğŸš€ éƒ¨ç½²åˆ° Staging
      run: |
        echo "å¼€å§‹ Staging ç¯å¢ƒéƒ¨ç½²..."
        ./scripts/deploy.sh --env=staging --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        echo "âœ… Staging éƒ¨ç½²å®Œæˆ"

    - name: ğŸ§ª éƒ¨ç½²éªŒè¯
      run: |
        node scripts/deployment-verification.js --env=staging
        echo "âœ… Staging éƒ¨ç½²éªŒè¯é€šè¿‡"

    - name: ğŸ“Š éƒ¨ç½²çŠ¶æ€æŠ¥å‘Š
      run: |
        echo "Staging éƒ¨ç½²çŠ¶æ€:"
        curl -f https://staging.frys.com/health || echo "å¥åº·æ£€æŸ¥å¤±è´¥"

  # 8ï¸âƒ£ å›å½’æµ‹è¯•
  regression:
    name: '7ï¸âƒ£ å›å½’æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: staging-deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ”„ å›å½’æµ‹è¯•çŸ©é˜µ
      run: |
        node scripts/regression-matrix.js --env=staging
        echo "âœ… å›å½’æµ‹è¯•é€šè¿‡"

    - name: ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        npm run benchmark
        echo "âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

    - name: ğŸ“ˆ ä¸Šä¼ å›å½’æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: regression-report
        path: |
          regression-test-results/
          benchmark-results/

  # 9ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²
  production-deploy:
    name: '8ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build, regression]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    environment: production

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ” ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts

    - name: ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
      run: |
        echo "å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
        ./scripts/deploy.sh --env=production --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ"

    - name: ğŸ§ª ç”Ÿäº§ç¯å¢ƒéªŒè¯
      run: |
        node scripts/deployment-verification.js --env=production
        echo "âœ… ç”Ÿäº§ç¯å¢ƒéªŒè¯é€šè¿‡"

    - name: ğŸ“Š ç”Ÿäº§éƒ¨ç½²ç›‘æ§
      run: |
        echo "ç”Ÿäº§ç¯å¢ƒç›‘æ§è®¾ç½®..."
        ./monitoring/setup-monitoring.sh --env=production

  # ğŸ” ç›‘æ§å›æº¯
  monitoring:
    name: '9ï¸âƒ£ ç›‘æ§å›æº¯'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [staging-deploy, production-deploy]
    if: always()

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ“Š æ”¶é›†ç›‘æ§æŒ‡æ ‡
      run: |
        echo "æ”¶é›†éƒ¨ç½²ç›‘æ§æŒ‡æ ‡..."
        node scripts/monitoring-rollback.js --check

    - name: ğŸ“‹ ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "ç”Ÿæˆå®Œæ•´éƒ¨ç½²æŠ¥å‘Š..."
        node scripts/ci-pipeline.js --generate-report

    - name: ğŸ“¤ ä¸Šä¼ ç›‘æ§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: deployment-monitoring-report
        path: |
          ci-pipeline-report.json
          deployment-verification-*.json
          monitoring-*.log

    - name: ğŸ¯ éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: success()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ needs.staging-deploy.result }}' === 'success' && '${{ needs.production-deploy.result }}' === 'success' ? 'âœ…' : 'âš ï¸';
          const message = `${status} **frys éƒ¨ç½²å®Œæˆ**

**æäº¤**: ${context.sha.substring(0, 7)}
**åˆ†æ”¯**: ${context.ref}
**ç¯å¢ƒ**: Staging + Production

[æŸ¥çœ‹éƒ¨ç½²è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });