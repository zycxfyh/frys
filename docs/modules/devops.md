# WokeFlow DevOps æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

<div style="background-color: #e8f4fd; padding: 20px; border-left: 5px solid #03a9f4; margin: 20px 0;">
  <h3 style="margin-top: 0; color: #01579b;">ğŸš€ ç°ä»£åŒ– DevOps å®è·µ</h3>
  <p>WokeFlow é‡‡ç”¨<strong>ç°ä»£åŒ– DevOps å®è·µ</strong>ï¼Œå®ç°ä»<strong>ä»£ç æäº¤åˆ°ç”Ÿäº§éƒ¨ç½²</strong>çš„å®Œæ•´è‡ªåŠ¨åŒ–æµæ°´çº¿ã€‚é€šè¿‡<strong>å®¹å™¨åŒ–</strong>ã€<strong>ç›‘æ§å‘Šè­¦</strong>ã€<strong>è‡ªåŠ¨åŒ–éƒ¨ç½²</strong>ç­‰æ‰‹æ®µï¼Œç¡®ä¿ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ã€å¯è§‚æµ‹æ€§å’Œå¿«é€Ÿè¿­ä»£èƒ½åŠ›ã€‚</p>
  <p><strong>æ ¸å¿ƒç›®æ ‡</strong>ï¼šè®©å¼€å‘è€…ä¸“æ³¨äºä¸šåŠ¡åˆ›æ–°ï¼ŒåŸºç¡€è®¾æ–½è‡ªåŠ¨åŒ–å¤„ç†ã€‚</p>
</div>

## ğŸ¯ DevOps æ¶æ„è®¾è®¡åŸåˆ™

### 1. ğŸ—ï¸ åŸºç¡€è®¾æ–½å³ä»£ç  (IaC)

<div style="background-color: #f3e5f5; padding: 15px; border-radius: 8px; margin: 15px 0;">
  <h4 style="margin-top: 0; color: #7b1fa2;">IaC æ ¸å¿ƒç†å¿µ</h4>
  <ul>
    <li><strong>ğŸ“ å£°æ˜å¼é…ç½®</strong>ï¼šä½¿ç”¨ Docker Composeã€Kubernetes ç­‰å£°æ˜å¼é…ç½®ç®¡ç†åŸºç¡€è®¾æ–½</li>
    <li><strong>ğŸ”„ ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šæ‰€æœ‰åŸºç¡€è®¾æ–½é…ç½®çº³å…¥ Git ç‰ˆæœ¬ç®¡ç†ï¼Œæ”¯æŒå›æ»šå’Œå®¡è®¡</li>
    <li><strong>ğŸ¤– è‡ªåŠ¨åŒ–éƒ¨ç½²</strong>ï¼šé€šè¿‡è„šæœ¬å’Œå·¥å…·å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œå‡å°‘äººå·¥å¹²é¢„</li>
    <li><strong>ğŸ”„ ä¸å¯å˜åŸºç¡€è®¾æ–½</strong>ï¼šç¯å¢ƒä¸å¯å˜ï¼Œæ¯æ¬¡éƒ¨ç½²åˆ›å»ºæ–°å®ä¾‹</li>
  </ul>

  <h4 style="margin-top: 20px; color: #7b1fa2;">IaC ä¼˜åŠ¿</h4>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
    <div style="background-color: #e1bee7; padding: 10px; border-radius: 5px;">
      <strong>ğŸ”’ ä¸€è‡´æ€§</strong><br/>
      å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒå®Œå…¨ä¸€è‡´
    </div>
    <div style="background-color: #e1bee7; padding: 10px; border-radius: 5px;">
      <strong>âš¡ å¯é‡ç°æ€§</strong><br/>
      ä»»ä½•ç¯å¢ƒå¯å¿«é€Ÿé‡å»º
    </div>
    <div style="background-color: #e1bee7; padding: 10px; border-radius: 5px;">
      <strong>ğŸ“Š å¯å®¡è®¡æ€§</strong><br/>
      æ‰€æœ‰å˜æ›´éƒ½æœ‰å†å²è®°å½•
    </div>
    <div style="background-color: #e1bee7; padding: 10px; border-radius: 5px;">
      <strong>ğŸš€ æ•æ·æ€§</strong><br/>
      å¿«é€Ÿåˆ›å»ºå’Œé”€æ¯ç¯å¢ƒ
    </div>
  </div>
</div>

### 2. ğŸ‘ï¸ å¯è§‚æµ‹æ€§ä¼˜å…ˆ (Observability First)

<div style="background-color: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
  <h4 style="margin-top: 0; color: #2e7d32;">ä¸‰å¤§å¯è§‚æµ‹æ€§æ”¯æŸ±</h4>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0;">
    <div style="background-color: #c8e6c9; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“Š</div>
      <strong>æŒ‡æ ‡ (Metrics)</strong><br/>
      <small>é‡åŒ–ç³»ç»Ÿæ€§èƒ½å’Œå¥åº·çŠ¶æ€</small>
    </div>
    <div style="background-color: #c8e6c9; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; margin-bottom: 10px;">ğŸ“</div>
      <strong>æ—¥å¿— (Logs)</strong><br/>
      <small>è®°å½•ç³»ç»Ÿè¿è¡Œæ—¶çš„äº‹ä»¶å’ŒçŠ¶æ€</small>
    </div>
    <div style="background-color: #c8e6c9; padding: 15px; border-radius: 8px; text-align: center;">
      <div style="font-size: 2em; margin-bottom: 10px;">ğŸ”</div>
      <strong>è¿½è¸ª (Traces)</strong><br/>
      <small>è·Ÿè¸ªè¯·æ±‚åœ¨ç³»ç»Ÿä¸­çš„å®Œæ•´è·¯å¾„</small>
    </div>
  </div>

  <h4 style="margin-top: 20px; color: #2e7d32;">å¯è§‚æµ‹æ€§å®ç°</h4>
  <ul>
    <li><strong>ğŸ“ˆ å…¨é¢ç›‘æ§</strong>ï¼šåº”ç”¨ã€æœåŠ¡ã€åŸºç¡€è®¾æ–½å¤šå±‚æ¬¡ç›‘æ§è¦†ç›–</li>
    <li><strong>ğŸ—ï¸ ç»“æ„åŒ–æ—¥å¿—</strong>ï¼šJSON æ ¼å¼ä¾¿äºåˆ†æå’Œå‘Šè­¦</li>
    <li><strong>âš¡ æ€§èƒ½æŒ‡æ ‡</strong>ï¼šå®æ—¶æ”¶é›†å’Œåˆ†ææ€§èƒ½æ•°æ®</li>
    <li><strong>ğŸ¯ ä¸šåŠ¡æŒ‡æ ‡</strong>ï¼šç›‘æ§ä¸šåŠ¡å…³é”®æŒ‡æ ‡å’Œ SLA</li>
  </ul>
</div>

### 3. ğŸ¤– è‡ªåŠ¨åŒ–è¿ç»´

<div style="background-color: #fff3e0; padding: 15px; border-radius: 8px; margin: 15px 0;">
  <h4 style="margin-top: 0; color: #f57c00;">è‡ªåŠ¨åŒ–æµç¨‹</h4>

  <div style="background-color: #f5f5f5; padding: 15px; border-radius: 8px; margin: 10px 0;">
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <span style="background-color: #4caf50; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; margin-right: 10px;">1</span>
      <strong>ä»£ç æäº¤</strong> â†’ Git Push
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <span style="background-color: #2196f3; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; margin-right: 10px;">2</span>
      <strong>CI æµæ°´çº¿</strong> â†’ è‡ªåŠ¨åŒ–æµ‹è¯•ã€æ„å»º
    </div>
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <span style="background-color: #ff9800; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; margin-right: 10px;">3</span>
      <strong>CD éƒ¨ç½²</strong> â†’ è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§
    </div>
    <div style="display: flex; align-items: center;">
      <span style="background-color: #9c27b0; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; margin-right: 10px;">4</span>
      <strong>ç›‘æ§å‘Šè­¦</strong> â†’ å®æ—¶ç›‘æ§å’Œè‡ªåŠ¨å“åº”
    </div>
  </div>

  <h4 style="margin-top: 20px; color: #f57c00;">è‡ªåŠ¨åŒ–ç‰¹æ€§</h4>
  <ul>
    <li><strong>ğŸ”„ CI/CD æµæ°´çº¿</strong>ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•ã€æ„å»ºã€éƒ¨ç½²æµç¨‹</li>
    <li><strong>ğŸ”µ è“ç»¿éƒ¨ç½²</strong>ï¼šé›¶åœæœºéƒ¨ç½²ç­–ç•¥ï¼Œä¿éšœä¸šåŠ¡è¿ç»­æ€§</li>
    <li><strong>â†©ï¸ è‡ªåŠ¨å›æ»š</strong>ï¼šéƒ¨ç½²å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬</li>
    <li><strong>âš¡ å¼¹æ€§ä¼¸ç¼©</strong>ï¼šåŸºäºè´Ÿè½½è‡ªåŠ¨è°ƒæ•´èµ„æº</li>
  </ul>
</div>

### 4. ğŸ›¡ï¸ å®‰å…¨ç¬¬ä¸€åŸåˆ™

<div style="background-color: #ffebee; padding: 15px; border-radius: 8px; margin: 15px 0;">
  <h4 style="margin-top: 0; color: #c62828;">å®‰å…¨å®è·µ</h4>
  <ul>
    <li><strong>ğŸ‘¤ æœ€å°æƒé™åŸåˆ™</strong>ï¼šå®¹å™¨ä½¿ç”¨é root ç”¨æˆ·ï¼ŒæœåŠ¡é‡‡ç”¨æœ€å°æƒé™è¿è¡Œ</li>
    <li><strong>ğŸ” å®‰å…¨æ‰«æ</strong>ï¼šä»£ç å’Œé•œåƒå®šæœŸè¿›è¡Œå®‰å…¨æ¼æ´æ‰«æ</li>
    <li><strong>ğŸšª è®¿é—®æ§åˆ¶</strong>ï¼šä¸¥æ ¼çš„ç½‘ç»œå’Œè®¿é—®æ§åˆ¶ï¼Œå®æ–½é›¶ä¿¡ä»»æ¶æ„</li>
    <li><strong>ğŸ” å¯†é’¥ç®¡ç†</strong>ï¼šå®‰å…¨çš„å¯†é’¥å­˜å‚¨å’Œè½®æ¢æœºåˆ¶</li>
    <li><strong>ğŸ“‹ å®¡è®¡æ—¥å¿—</strong>ï¼šå®Œæ•´çš„å®‰å…¨äº‹ä»¶å®¡è®¡å’Œç›‘æ§</li>
  </ul>

  <h4 style="margin-top: 20px; color: #c62828;">å®‰å…¨ç”Ÿå‘½å‘¨æœŸ</h4>
  <div style="background-color: #ffcdd2; padding: 10px; border-radius: 5px; margin-top: 10px;">
    <strong>ğŸ”’ å®‰å…¨èå…¥æ¯ä¸ªç¯èŠ‚</strong>ï¼šä»ä»£ç ç¼–å†™åˆ°ç”Ÿäº§éƒ¨ç½²ï¼Œå…¨æµç¨‹å®‰å…¨ä¿éšœ
  </div>
</div>

## å®¹å™¨åŒ–éƒ¨ç½²

### Docker é•œåƒæ„å»º

#### Dockerfile è®¾è®¡

```dockerfile
# WokeFlow ç”Ÿäº§çº§Dockeré•œåƒ
FROM node:20-alpine

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    git \
    curl \
    && rm -rf /var/cache/apk/*

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN npm ci --only=production && npm cache clean --force

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup -g 1001 -S nodejs && \
    adduser -S wokeflow -u 1001

# æ›´æ”¹æ–‡ä»¶æ‰€æœ‰æƒ
RUN chown -R wokeflow:nodejs /app
USER wokeflow

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1

# å¯åŠ¨åº”ç”¨
CMD ["node", "src/index.js"]
```

#### é•œåƒä¼˜åŒ–ç­–ç•¥

##### å¤šé˜¶æ®µæ„å»º
```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# ç”Ÿäº§é•œåƒ
FROM node:20-alpine AS production
COPY --from=builder /app/node_modules ./node_modules
COPY . .
# ... å…¶ä½™é…ç½®
```

##### å±‚ç¼“å­˜ä¼˜åŒ–
- ä¾èµ–å®‰è£…ç‹¬ç«‹å±‚
- ä»£ç å¤åˆ¶åœ¨æœ€å
- ä½¿ç”¨ .dockerignore æ’é™¤ä¸å¿…è¦æ–‡ä»¶

##### å®‰å…¨åŠ å›º
- ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ
- æœ€å°åŒ–åŸºç¡€é•œåƒ (alpine)
- åˆ é™¤ä¸å¿…è¦çš„åŒ…å’Œç¼“å­˜

### Docker Compose é…ç½®

#### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
version: '3.8'

services:
  # WokeFlow åº”ç”¨ - è“ç¯å¢ƒ
  wokeflow-blue:
    image: wokeflow/production:latest
    container_name: wokeflow-blue
    environment:
      - NODE_ENV=production
      - DEPLOY_ENV=blue
    env_file:
      - .env.production
    ports:
      - "3001:3000"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - postgres
      - redis
    networks:
      - wokeflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # WokeFlow åº”ç”¨ - ç»¿ç¯å¢ƒ
  wokeflow-green:
    image: wokeflow/production:latest
    container_name: wokeflow-green
    environment:
      - NODE_ENV=production
      - DEPLOY_ENV=green
    env_file:
      - .env.production
    ports:
      - "3002:3000"
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - postgres
      - redis
    networks:
      - wokeflow-network
    restart: unless-stopped
    profiles:
      - green  # é»˜è®¤ä¸å¯åŠ¨

  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:15-alpine
    container_name: wokeflow-postgres
    environment:
      - POSTGRES_DB=wokeflow_prod
      - POSTGRES_USER=wokeflow
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - wokeflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wokeflow"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis ç¼“å­˜
  redis:
    image: redis:7-alpine
    container_name: wokeflow-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - wokeflow-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:1.25-alpine
    container_name: wokeflow-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - wokeflow-blue
    networks:
      - wokeflow-network
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:

networks:
  wokeflow-network:
    driver: bridge
```

#### æµ‹è¯•ç¯å¢ƒé…ç½®

```yaml
version: '3.8'

services:
  # WokeFlow æµ‹è¯•ç¯å¢ƒ
  wokeflow-staging:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wokeflow-staging
    environment:
      - NODE_ENV=staging
    env_file:
      - .env.staging
    ports:
      - "3000:3000"
    volumes:
      - ./logs:/app/logs
    depends_on:
      - postgres-staging
      - redis-staging
    networks:
      - staging-network
    restart: unless-stopped

  # PostgreSQL æµ‹è¯•æ•°æ®åº“
  postgres-staging:
    image: postgres:15-alpine
    container_name: wokeflow-postgres-staging
    environment:
      - POSTGRES_DB=wokeflow_staging
      - POSTGRES_USER=wokeflow
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_staging_data:/var/lib/postgresql/data
    networks:
      - staging-network
    restart: unless-stopped

  # Redis æµ‹è¯•ç¼“å­˜
  redis-staging:
    image: redis:7-alpine
    container_name: wokeflow-redis-staging
    volumes:
      - redis_staging_data:/data
    networks:
      - staging-network
    restart: unless-stopped

volumes:
  postgres_staging_data:
  redis_staging_data:

networks:
  staging-network:
    driver: bridge
```

## è“ç»¿éƒ¨ç½²ç­–ç•¥

### éƒ¨ç½²æµç¨‹

#### 1. éƒ¨ç½²å‡†å¤‡
```bash
# æ„å»ºæ–°ç‰ˆæœ¬é•œåƒ
docker build -t wokeflow/production:v1.2.3 .

# æ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨
docker push wokeflow/production:v1.2.3

# æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬
docker tag wokeflow/production:v1.2.3 wokeflow/production:latest
```

#### 2. è“ç»¿éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash

# è“ç»¿éƒ¨ç½²è„šæœ¬
set -euo pipefail

# ç¡®å®šç›®æ ‡ç¯å¢ƒ
ACTIVE_ENV=$(get_active_environment)
if [ "$ACTIVE_ENV" = "blue" ]; then
    DEPLOY_ENV="green"
    INACTIVE_ENV="blue"
else
    DEPLOY_ENV="blue"
    INACTIVE_ENV="green"
fi

echo "éƒ¨ç½²åˆ° $DEPLOY_ENV ç¯å¢ƒï¼Œåœæ­¢ $INACTIVE_ENV ç¯å¢ƒ"

# å¯åŠ¨æ–°ç¯å¢ƒ
docker-compose up -d "wokeflow-$DEPLOY_ENV"

# ç­‰å¾…å¥åº·æ£€æŸ¥
if check_health "wokeflow-$DEPLOY_ENV"; then
    echo "âœ… $DEPLOY_ENV ç¯å¢ƒéƒ¨ç½²æˆåŠŸ"
    
    # åˆ‡æ¢æµé‡
    switch_traffic "$DEPLOY_ENV"
    
    # åœæ­¢æ—§ç¯å¢ƒ
    docker-compose stop "wokeflow-$INACTIVE_ENV"
    
    echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
else
    echo "âŒ $DEPLOY_ENV ç¯å¢ƒéƒ¨ç½²å¤±è´¥"
    
    # åœæ­¢å¤±è´¥çš„ç¯å¢ƒ
    docker-compose stop "wokeflow-$DEPLOY_ENV"
    
    exit 1
fi
```

#### 3. æµé‡åˆ‡æ¢

```nginx
# Nginx é…ç½® - è“ç¯å¢ƒ
upstream wokeflow_backend {
    server wokeflow-blue:3000;
}

# Nginx é…ç½® - ç»¿ç¯å¢ƒ
upstream wokeflow_backend {
    server wokeflow-green:3000;
}
```

### éƒ¨ç½²éªŒè¯

#### å¥åº·æ£€æŸ¥
```bash
# åº”ç”¨å¥åº·æ£€æŸ¥
curl -f http://localhost:3000/health

# æ•°æ®åº“è¿æ¥æ£€æŸ¥
docker-compose exec wokeflow-blue node -e "
const { Client } = require('pg');
const client = new Client();
client.connect().then(() => {
    console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ');
    client.end();
}).catch(console.error);
"
```

#### åŠŸèƒ½æµ‹è¯•
```bash
# API åŠŸèƒ½æµ‹è¯•
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# å·¥ä½œæµæµ‹è¯•
curl -X POST http://localhost:3000/api/workflows \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"éƒ¨ç½²éªŒè¯å·¥ä½œæµ","tasks":[]}'
```

### å›æ»šç­–ç•¥

#### è‡ªåŠ¨å›æ»š
```bash
#!/bin/bash

# å›æ»šè„šæœ¬
FAILED_ENV=$1

echo "éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹å›æ»š..."

# åˆ‡æ¢å›æ—§ç¯å¢ƒ
switch_traffic_to_previous

# åœæ­¢å¤±è´¥çš„ç¯å¢ƒ
docker-compose stop "wokeflow-$FAILED_ENV"

# å‘é€å‘Šè­¦
send_alert "éƒ¨ç½²å¤±è´¥ï¼Œå·²å›æ»šåˆ°ç¨³å®šç‰ˆæœ¬"

echo "å›æ»šå®Œæˆ"
```

## ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

### Prometheus ç›‘æ§

#### åº”ç”¨æŒ‡æ ‡æ”¶é›†

```javascript
// src/core/PrometheusInspiredMetrics.js
import { register, collectDefaultMetrics, Gauge, Counter, Histogram } from 'prom-client';

// æ”¶é›†é»˜è®¤æŒ‡æ ‡
collectDefaultMetrics();

// è‡ªå®šä¹‰æŒ‡æ ‡
const httpRequestTotal = new Counter({
  name: 'wokeflow_http_requests_total',
  help: 'Total number of HTTP requests',
  labelNames: ['method', 'route', 'status_code']
});

const httpRequestDuration = new Histogram({
  name: 'wokeflow_http_request_duration_seconds',
  help: 'Duration of HTTP requests in seconds',
  labelNames: ['method', 'route']
});

const activeConnections = new Gauge({
  name: 'wokeflow_active_connections',
  help: 'Number of active connections'
});

const workflowActive = new Gauge({
  name: 'wokeflow_workflows_active',
  help: 'Number of currently active workflows'
});

// æŒ‡æ ‡æ”¶é›†ä¸­é—´ä»¶
export const metricsMiddleware = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    
    httpRequestTotal
      .labels(req.method, req.route?.path || req.path, res.statusCode.toString())
      .inc();
    
    httpRequestDuration
      .labels(req.method, req.route?.path || req.path)
      .observe(duration);
  });
  
  next();
};
```

#### Prometheus é…ç½®

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  # WokeFlow åº”ç”¨ç›‘æ§
  - job_name: 'wokeflow-blue'
    static_configs:
      - targets: ['wokeflow-blue:3000']
        labels:
          environment: 'production'
          deployment: 'blue'
    scrape_interval: 10s
    metrics_path: '/metrics'

  - job_name: 'wokeflow-green'
    static_configs:
      - targets: ['wokeflow-green:3000']
        labels:
          environment: 'production'
          deployment: 'green'
    scrape_interval: 10s
    metrics_path: '/metrics'

  # åŸºç¡€è®¾æ–½ç›‘æ§
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:5432']
    scrape_interval: 30s

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
    scrape_interval: 30s
```

### AlertManager å‘Šè­¦

#### å‘Šè­¦è§„åˆ™

```yaml
groups:
  - name: wokeflow.rules
    rules:
      # åº”ç”¨å®ä¾‹å®•æœºå‘Šè­¦
      - alert: WokeFlowInstanceDown
        expr: up{job="wokeflow-blue"} == 0
        for: 1m
        labels:
          severity: critical
          service: wokeflow
        annotations:
          summary: "WokeFlow å®ä¾‹å®•æœº"
          description: "WokeFlow å®ä¾‹ {{ $labels.instance }} å·²å®•æœºè¶…è¿‡1åˆ†é’Ÿ"

      # é«˜é”™è¯¯ç‡å‘Šè­¦
      - alert: WokeFlowHighErrorRate
        expr: rate(wokeflow_http_requests_total{status_code=~"5.."}[5m]) / rate(wokeflow_http_requests_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          service: wokeflow
        annotations:
          summary: "WokeFlow é«˜é”™è¯¯ç‡"
          description: "HTTP é”™è¯¯ç‡è¶…è¿‡ 10% æŒç»­ 2 åˆ†é’Ÿ"

      # å“åº”æ—¶é—´è¿‡é•¿å‘Šè­¦
      - alert: WokeFlowHighResponseTime
        expr: histogram_quantile(0.95, rate(wokeflow_http_request_duration_seconds_bucket[5m])) > 5
        for: 2m
        labels:
          severity: warning
          service: wokeflow
        annotations:
          summary: "WokeFlow å“åº”æ—¶é—´è¿‡é•¿"
          description: "95% è¯·æ±‚å“åº”æ—¶é—´è¶…è¿‡ 5 ç§’æŒç»­ 2 åˆ†é’Ÿ"

      # å†…å­˜ä½¿ç”¨è¿‡é«˜å‘Šè­¦
      - alert: WokeFlowHighMemoryUsage
        expr: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) > 0.9
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "å†…å­˜ä½¿ç”¨è¿‡é«˜"
          description: "ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 90% æŒç»­ 5 åˆ†é’Ÿ"
```

#### å‘Šè­¦æ¥æ”¶å™¨é…ç½®

```yaml
route:
  group_by: ['alertname', 'service', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'wokeflow-alerts'
  routes:
    # ä¸¥é‡å‘Šè­¦ - ç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'wokeflow-critical'
      continue: true

receivers:
  # ä¸¥é‡å‘Šè­¦ - ç«‹å³å“åº”
  - name: 'wokeflow-critical'
    email_configs:
      - to: 'oncall@wokeflow.com'
        subject: 'ğŸš¨ ä¸¥é‡å‘Šè­¦: {{ .GroupLabels.alertname }}'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#critical-alerts'
        title: 'ğŸš¨ ä¸¥é‡å‘Šè­¦'
        color: 'danger'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
```

### æ—¥å¿—èšåˆ

#### ELK Stack é…ç½®

```yaml
# Filebeat é…ç½®
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /app/logs/wokeflow.log
    json.keys_under_root: true
    json.add_error_key: true

output.elasticsearch:
  hosts: ["elasticsearch:9200"]
  index: "wokeflow-%{+yyyy.MM.dd}"
```

#### Kibana å¯è§†åŒ–
- åˆ›å»ºä»ªè¡¨ç›˜æ˜¾ç¤ºé”™è¯¯ç‡è¶‹åŠ¿
- è®¾ç½®å‘Šè­¦è§„åˆ™åŸºäºæ—¥å¿—æ¨¡å¼
- å»ºç«‹ç”¨æˆ·è¡Œä¸ºåˆ†æè§†å›¾

## CI/CD æµæ°´çº¿

### GitHub Actions é…ç½®

```yaml
name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # æµ‹è¯•é˜¶æ®µ
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint code
        run: npm run lint

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Security scan
        run: npm run test:security

      - name: Generate coverage report
        run: npm run test:coverage

  # æ„å»ºå’Œæ¨é€é•œåƒ
  build:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
      
      - name: Build Docker image
        run: docker build -t wokeflow/production:${{ github.sha }} .

      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push wokeflow/production:${{ github.sha }}
          docker tag wokeflow/production:${{ github.sha }} wokeflow/production:latest
          docker push wokeflow/production:latest

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: staging
    steps:
      - name: Deploy to staging
        run: |
          ssh user@staging-server << EOF
            cd /opt/wokeflow
            docker-compose pull
            ./scripts/deploy.sh --env=staging
          EOF

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: Deploy to production
        run: |
          ssh user@prod-server << EOF
            cd /opt/wokeflow
            docker-compose pull
            ./scripts/deploy.sh --env=production
          EOF
```

### è´¨é‡é—¨ç¦

#### ä»£ç è´¨é‡æ£€æŸ¥
```yaml
# SonarQube é…ç½®
- name: SonarQube Scan
  uses: sonarsource/sonarsource.github.action.scan@v1
  env:
    SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

# å®‰å…¨æ‰«æ
- name: Security Scan
  uses: securecodewarrior/github-action-gosec@master
  with:
    args: './...'
```

#### è¦†ç›–ç‡è¦æ±‚
```yaml
# è¦†ç›–ç‡é—¨ç¦
- name: Coverage Gate
  run: |
    COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
    if (( $(echo "$COVERAGE < 80" | bc -l) )); then
      echo "Coverage is below 80%: $COVERAGE%"
      exit 1
    fi
```

## å¤‡ä»½å’Œæ¢å¤

### æ•°æ®åº“å¤‡ä»½

```bash
#!/bin/bash

# PostgreSQL å¤‡ä»½è„šæœ¬
BACKUP_DIR="./backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

# å…¨é‡å¤‡ä»½
docker-compose exec postgres pg_dumpall -U wokeflow > "$BACKUP_DIR/full_backup.sql"

# å‹ç¼©å¤‡ä»½
gzip "$BACKUP_DIR/full_backup.sql"

# æ¸…ç†æ—§å¤‡ä»½ï¼ˆä¿ç•™7å¤©ï¼‰
find ./backups -name "*.gz" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

### åº”ç”¨é…ç½®å¤‡ä»½

```bash
#!/bin/bash

# é…ç½®å¤‡ä»½è„šæœ¬
BACKUP_DIR="./config_backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

# å¤‡ä»½ç¯å¢ƒå˜é‡æ–‡ä»¶
cp .env.production "$BACKUP_DIR/"
cp .env.staging "$BACKUP_DIR/"

# å¤‡ä»½ Docker Compose é…ç½®
cp docker-compose.yml "$BACKUP_DIR/"
cp docker-compose.production.yml "$BACKUP_DIR/"

# å¤‡ä»½ Nginx é…ç½®
cp -r nginx/ "$BACKUP_DIR/"

echo "é…ç½®å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

### ç¾éš¾æ¢å¤

#### æ•°æ®æ¢å¤æµç¨‹
1. åœæ­¢åº”ç”¨æœåŠ¡
2. ä»å¤‡ä»½æ¢å¤æ•°æ®åº“
3. æ¢å¤é…ç½®æ–‡ä»¶
4. é‡å¯åº”ç”¨æœåŠ¡
5. æ‰§è¡Œå®Œæ•´æ€§æ£€æŸ¥

#### æ¢å¤è„šæœ¬
```bash
#!/bin/bash

# ç¾éš¾æ¢å¤è„šæœ¬
BACKUP_FILE=$1

if [ -z "$BACKUP_FILE" ]; then
    echo "è¯·æŒ‡å®šå¤‡ä»½æ–‡ä»¶"
    exit 1
fi

echo "å¼€å§‹ç¾éš¾æ¢å¤..."

# åœæ­¢æœåŠ¡
docker-compose down

# æ¢å¤æ•°æ®åº“
gunzip -c "$BACKUP_FILE" | docker-compose exec -T postgres psql -U wokeflow

# é‡å¯æœåŠ¡
docker-compose up -d

# å¥åº·æ£€æŸ¥
sleep 30
if curl -f http://localhost/health; then
    echo "âœ… æ¢å¤æˆåŠŸ"
else
    echo "âŒ æ¢å¤å¤±è´¥"
    exit 1
fi
```

## æ€»ç»“

WokeFlow çš„ DevOps æ¶æ„é€šè¿‡å®¹å™¨åŒ–éƒ¨ç½²ã€è“ç»¿å‘å¸ƒç­–ç•¥ã€å…¨é¢ç›‘æ§å‘Šè­¦ç³»ç»Ÿå’Œè‡ªåŠ¨åŒ– CI/CD æµæ°´çº¿ï¼Œå®ç°äº†é«˜å¯ç”¨ã€å¯è§‚æµ‹ã€å¿«é€Ÿè¿­ä»£çš„ç°ä»£åŒ–è¿ç»´ä½“ç³»ã€‚è¿™ç§è®¾è®¡æ—¢ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œåˆæ”¯æŒäº†å¿«é€Ÿçš„ä¸šåŠ¡åˆ›æ–°å’Œéƒ¨ç½²ã€‚
