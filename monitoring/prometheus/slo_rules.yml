groups:
  # 服务水平目标 (SLO) 监控
  - name: wokeflow_slo_monitoring
    rules:
      # API 可用性 SLO - 99.9% 每月可用性
      - alert: SLOAPIAvailabilityViolation
        expr: |
          1 - (
            sum(rate(http_requests_total{status!~"5..", job=~"wokeflow-(blue|green)"}[30d]))
            /
            sum(rate(http_requests_total{job=~"wokeflow-(blue|green)"}[30d]))
          ) < 0.999
        for: 1h
        labels:
          severity: critical
          slo: api_availability
          target: 99.9%
        annotations:
          summary: "API 可用性 SLO 违反"
          description: "API 可用性低于 99.9% (当前: {{ $value | printf \"%.3f\" }})"
          runbook_url: "https://docs.wokeflow.com/runbooks/slo-violation"

      # API 响应时间 SLO - 95% 请求在 500ms 内完成
      - alert: SLOAPIResponseTimeViolation
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{le="0.5", job=~"wokeflow-(blue|green)"}[7d]))
          /
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=~"wokeflow-(blue|green)"}[7d])) < 0.95
        for: 1h
        labels:
          severity: warning
          slo: api_response_time
          target: 500ms@95%
        annotations:
          summary: "API 响应时间 SLO 违反"
          description: "95% API 请求响应时间超过 500ms"
          runbook_url: "https://docs.wokeflow.com/runbooks/slo-violation"

      # 错误预算消耗过快
      - alert: SLOErrorBudgetBurnRate
        expr: |
          rate(http_requests_total{status=~"5..", job=~"wokeflow-(blue|green)"}[1h])
          /
          rate(http_requests_total{job=~"wokeflow-(blue|green)"}[1h]) > 0.001
        for: 1h
        labels:
          severity: warning
          slo: error_budget
        annotations:
          summary: "错误预算消耗过快"
          description: "错误率超过每月 0.1% 预算的消耗速度"
          runbook_url: "https://docs.wokeflow.com/runbooks/error-budget"

  # SLO 指标计算
  - name: slo_metrics
    rules:
      # API 可用性指标
      - record: slo:api_availability:ratio
        expr: |
          sum(rate(http_requests_total{status!~"5..", job=~"wokeflow-(blue|green)"}[5m]))
          /
          sum(rate(http_requests_total{job=~"wokeflow-(blue|green)"}[5m]))

      # API 响应时间指标
      - record: slo:api_latency:p95
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job=~"wokeflow-(blue|green)"}[5m]))

      - record: slo:api_latency:p99
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket{job=~"wokeflow-(blue|green)"}[5m]))

      # 错误率指标
      - record: slo:error_rate:ratio
        expr: |
          sum(rate(http_requests_total{status=~"5..", job=~"wokeflow-(blue|green)"}[5m]))
          /
          sum(rate(http_requests_total{job=~"wokeflow-(blue|green)"}[5m]))

      # 错误预算剩余
      - record: slo:error_budget:remaining
        expr: 1 - slo:error_rate:ratio

      # 吞吐量指标
      - record: slo:throughput:requests_per_second
        expr: sum(rate(http_requests_total{job=~"wokeflow-(blue|green)"}[5m]))

  # 性能指标
  - name: performance_indicators
    rules:
      # Apdex 满意度评分
      - record: apdex:satisfaction_score
        expr: |
          (
            sum(rate(http_request_duration_seconds_bucket{le="0.5", job=~"wokeflow-(blue|green)"}[5m])) +
            sum(rate(http_request_duration_seconds_bucket{le="2.0", job=~"wokeflow-(blue|green)"}[5m]))
          ) / 2 / sum(rate(http_requests_total{job=~"wokeflow-(blue|green)"}[5m]))

      # 资源利用率
      - record: system:cpu_usage:percentage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

      - record: system:memory_usage:percentage
        expr: 100 - ((node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100)

      - record: system:disk_usage:percentage
        expr: 100 - ((node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100)

      # 应用性能指标
      - record: application:heap_usage:bytes
        expr: process_resident_memory_bytes{job=~"wokeflow-(blue|green)"}

      - record: application:gc_duration:seconds
        expr: rate(go_gc_duration_seconds_sum[5m])

      - record: application:goroutines:count
        expr: go_goroutines{job=~"wokeflow-(blue|green)"}
