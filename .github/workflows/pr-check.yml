name: ğŸ” PR æ£€æŸ¥æµæ°´çº¿

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

# ç®€åŒ–çš„PRæ£€æŸ¥ - ä¸»è¦è´¨é‡æ£€æŸ¥ç”±ä¸»CIå·¥ä½œæµå¤„ç†
jobs:
  pr-gate:
    name: 'ğŸšª PR å…¥å£æ£€æŸ¥'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false
    outputs:
      should_proceed: ${{ steps.pr-check.outputs.should_proceed }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ” PR åŸºç¡€åˆè§„æ€§æ£€æŸ¥
      id: pr-check
      run: |
        echo "ğŸ” æ‰§è¡ŒPRåŸºç¡€åˆè§„æ€§æ£€æŸ¥..."

        # æ£€æŸ¥åˆ†æ”¯å‘½å
        BRANCH_NAME="${{ github.head_ref }}"
        if [[ ! "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix|chore)/ ]]; then
          echo "âŒ åˆ†æ”¯å‘½åä¸ç¬¦åˆè§„èŒƒ: $BRANCH_NAME"
          echo "å»ºè®®ä½¿ç”¨: feature/ã€bugfix/ã€hotfix/ æˆ– chore/ å‰ç¼€"
          echo "should_proceed=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        # æ£€æŸ¥PRå¤§å°
        CHANGED_FILES=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo "0")
        CHANGED_LINES=$(git diff --stat HEAD~1 2>/dev/null | tail -1 | awk '{print $4+$6}' || echo "0")

        echo "ä¿®æ”¹æ–‡ä»¶æ•°: $CHANGED_FILES"
        echo "ä¿®æ”¹è¡Œæ•°: $CHANGED_LINES"

        if [ "$CHANGED_FILES" -gt 100 ] || [ "$CHANGED_LINES" -gt 2000 ]; then
          echo "âš ï¸  PRè¾ƒå¤§($CHANGED_FILES æ–‡ä»¶, $CHANGED_LINES è¡Œ)ï¼Œå»ºè®®æ‹†åˆ†"
          # ä¸é˜»å¡ï¼Œä»…è­¦å‘Š
        fi

        # æ£€æŸ¥æ˜¯å¦åŒ…å«æµ‹è¯•
        HAS_TESTS=$(git diff --name-only HEAD~1 | grep -E "\.(test|spec)\.js$" | wc -l)
        if [ "$HAS_TESTS" -eq "0" ]; then
          echo "âš ï¸  PRæœªåŒ…å«æµ‹è¯•æ–‡ä»¶ï¼Œå»ºè®®æ·»åŠ ç›¸å…³æµ‹è¯•"
          # ä¸é˜»å¡ï¼Œä»…è­¦å‘Š
        fi

        echo "should_proceed=true" >> $GITHUB_OUTPUT
        echo "âœ… PRåŸºç¡€æ£€æŸ¥é€šè¿‡"

  pr-status-check:
    name: 'ğŸ“Š PR çŠ¶æ€ç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: pr-gate
    if: needs.pr-gate.outputs.should_proceed == 'true'

    steps:
    - name: ğŸ“‹ ç­‰å¾…ä¸»CIå·¥ä½œæµå®Œæˆ
      run: |
        echo "ğŸ“‹ PRæ£€æŸ¥å°†ç”±ä¸»CIå·¥ä½œæµå¤„ç†..."
        echo "è¯·æŸ¥çœ‹ä¸»CIå·¥ä½œæµçš„PRå®¡æ ¸é˜¶æ®µç»“æœ"

    - name: ğŸ’¬ PR çŠ¶æ€æ›´æ–°
      uses: actions/github-script@v7
      with:
        script: |
          const status = 'â³';
          const message = `${status} **PR æ£€æŸ¥è¿›è¡Œä¸­**

æ­£åœ¨æ‰§è¡Œå®Œæ•´çš„è´¨é‡æ£€æŸ¥æµç¨‹ï¼š

ğŸ” æœ¬åœ°éªŒè¯ â†’ ğŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯• â†’ ğŸ”’ å®‰å…¨æ£€æŸ¥ â†’ ğŸ”— é›†æˆæµ‹è¯• â†’ ğŸ‘ï¸ è‡ªåŠ¨å®¡æŸ¥

è¯·è€å¿ƒç­‰å¾…æ£€æŸ¥å®Œæˆï¼Œæ‰€æœ‰ç»“æœå°†åœ¨ä¸‹æ–¹æ˜¾ç¤ºã€‚

---
*ä¸»CIå·¥ä½œæµ: [æŸ¥çœ‹è¿›åº¦](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
