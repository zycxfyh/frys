# 🚀 frys 工业级软件开发与部署完整流程

## 📋 总体流程概览

```
需求 → 拆解 → 骨架 → 分段生成 → 本地验证 → 自动化测试 → 静态/安全检查 → 集成测试 → PR 审核（自动+人工）→ staging 运行 → 回归矩阵验证 → 合并与部署 → 监控与回溯
```

---

## 1. 📥 入口与输入治理（防止目标模糊）

### 目的

把自然语言需求变成可执行的"工程任务卡"，避免 AI 因模糊目标胡写代码。

### 产出

- **任务卡（1 页）**，包含：
  - 🎯 目标
  - ✅ 接受标准（验收测试）
  - 🔒 约束（技术栈/版本/库白名单/禁止）
  - 📝 样例输入输出
  - ⚡ 性能/安全要求
  - 👤 Owner

### 负责人

**产品/PO 填写** → **开发负责人确认（签名/审批）**

### 验收标准

- ✅ 目标具备可测验的指标（至少一个明确断言）
- ✅ 有示例输入/输出（至少 3 个正例/2 个边界/2 个异常）
- ✅ 列出允许/禁止的第三方库

### 常见失败 & 对策

- ❌ **失败：无示例输入** → 要求补齐
- ❌ **失败：无性能要求** → 暂设合理默认（响应 < 500ms / DB query < 100ms）并标注待确认

---

## 2. 🔀 功能拆解与接口定义（强制先设计后编码）

### 目的

把任务拆为最小可交付单元（功能粒度），明确接口契约。

### 产出

- 📋 **功能清单**（每个功能一行：描述 + 输入/输出 + 验收测试）
- 🔌 **API 合约**（路由/方法/请求 body/response schema/错误码）
- 🗄️ **数据模型**（ER 或 JSON schema）
- 🔄 **状态机或事务边界**（如果有）

### 负责人

**开发负责人（或架构师）主导** + **PO 审核**

### 验收标准

- ✅ 所有功能都有明确的测试例（unit / integration）
- ✅ API 合约能自动转换为测试 skeleton（Postman/pytest 请求样例）

### 失败 & 对策

- ❌ **若发现职责交叉** → 重新划分模块边界并写决策记录

---

## 3. 🏗️ 代码骨架生成（强制先生成框架）

### 目的

先生成项目结构、接口与类型定义，避免一次性写大量业务逻辑导致耦合。

### 产出

- 📁 **项目目录树**
- 🔧 **Interface/DTO/Schema 文件**（类型定义）
- 📦 **空实现的 service/controller/repository**（with TODO）
- ⚙️ **CI 配置 skeleton**（测试、lint、typecheck 步骤）
- 📖 **README + 环境变量模板**

### 负责人

**AI 生成** + **人类复核（快速 review）**

### 验收标准

- ✅ 目录与文件与接口契约一一对应
- ✅ CI skeleton 在本地能跑通（即使只是空实现的测试 runner）

### 常见问题

- ❌ **空实现里缺少必要依赖注入点** → 在骨架复核环节补齐

---

## 4. 🧩 分段（函数/类级）生成与约束（单一职责）

### 目的

把每个函数/类作为独立小任务用 AI 生成，降低错误范围；为每段定义清晰的输入/输出/异常行为。

### 产出（每个小任务）

- 📝 **任务描述**（目的、输入、输出、边界条件、预期复杂度）
- 💻 **生成后的实现**
- 🧪 **对应单元测试**（含正/负例）
- 🔍 **自检报告**（AI 自动列出可能风险点）

### 负责人

**AI 生成** → **本地自动运行测试** → **人类 spot check（抽样）**

### 验收标准

- ✅ 单元测试全部通过（本地/CI）
- ✅ 代码风格 lint 通过、类型检查通过

### 失败 & 处理

- ❌ **若测试失败**：AI 自动生成修复补丁并重新运行（最多 N 次），超过阈值转人工介入

---

## 5. 🏠 本地验证与执行环境（真实运行而非仅编译）

### 目的

确保在近生产环境的容器/虚拟环境里能运行，减少"在我的机子上能跑"的问题。

### 产出

- 🐳 **本地 docker-compose 或 devcontainer**，可复现依赖
- 🤖 **Mock/Stub 服务**（外部 API/DB）
- 🚀 **集成 smoke tests**（端到端最小路径）

### 负责人

**Dev 环境** + **CI runner 执行**

### 验收标准

- ✅ Smoke tests pass in dev container
- ✅ DB migration 能正确 run / rollback

### 常见失败

- ❌ **环境差异（dev vs CI）** → 标准化镜像并固定版本

---

## 6. 🧪 自动化测试策略（必须覆盖）

### 目的

保证代码质量与业务正确性（单元、集成、端到端、契约测试）。

### 测试类型与最低要求

- 🧩 **单元测试**：覆盖核心逻辑，覆盖率 baseline ≥ 75%
- 🔗 **集成测试**：外部依赖交互路径（DB, message queue）
- 🌐 **端到端（E2E）测试**：关键用户路径（登录、关键 API）
- 📋 **Contract tests**：确保服务间兼容性
- 🔄 **Regression tests**：完整回归集合（重点用例）

### 负责人

**AI 生成测试模板** + **测试自动执行器（CI）**

### 验收标准

- ✅ 所有测试在 CI 中 green
- ✅ 集成测试在 staging 环境通过

### 失败 & 对策

- ❌ **测试不稳定（flaky）** → 标记并隔离 flaky tests，分析 root cause（race conditions / timing）

---

## 7. 🔍 静态分析与安全扫描（必做）

### 目的

捕获低级错误、类型问题、已知漏洞与不安全模式。

### 工具/检查点

- 🔧 **Linter**（ESLint / pylint / golangci-lint）
- 📝 **类型检查**（TypeScript tsc / mypy）
- 🛡️ **SAST**（Semgrep / Bandit / SonarQube）
- 📦 **依赖漏洞扫描**（Snyk / Dependabot / npm audit）
- 🔐 **Secrets scanning**（GitGuardian / truffleHog）

### 负责人

**CI 自动执行** → **安全负责人监督（高风险报警）**

### 验收标准

- ✅ Lint/Typecheck 0 错误（可有警告）
- ✅ SAST no high-severity issue
- ✅ 依赖漏洞 critical = 0，major ≤ accepted limit

### 失败 & 处理

- ❌ **发现 high-severity** → 阻塞 PR，必须修复或提出减缓计划

---

## 8. 🔄 PR 策略与审查（自动+人工结合）

### 目的

保证每次合并都符合质量门。

### PR 模板（必填）

```
## 📋 PR 描述

### 🎯 变更概述（为什么）
[简要说明变更原因]

### 🎫 关联任务卡 ID
[TASK-XXX]

### 📊 影响范围（模块/接口）
[列出受影响的模块/API]

### 🧪 测试结果
- ✅ 单元测试：通过/总数
- ✅ 集成测试：通过/总数
- ✅ Lint：通过
- ✅ Coverage：XX%

### ⚡ 性能影响评估
[如有性能影响，请说明]

### 🔒 安全/合规注意点
[安全考虑或合规要求]

### 🔙 回滚计划
[简单的回滚步骤描述]
```

### 审查规则

- ✅ **自动条件**（CI 全绿）满足后才可人工 review
- ✅ **小变更**（<200 行）：至少 1 名 reviewer
- ✅ **大变更**（>200 行或架构变更）：至少 2 名 reviewer，包含架构/安全负责人
- ✅ **关键操作**（DB schema change / data migration / prod config）：需通过 staging 验证并人工批准

### 验收标准

- ✅ Review comments 已被处理或合理解释
- ✅ 测试覆盖要求满足
- ✅ 安全扫描结果合格

### 失败 & 对策

- ❌ **Review 发现架构问题** → 回退到"架构契约"阶段重新设计

---

## 9. 🚀 集成到 Staging 与回归矩阵验证

### 目的

在接近真实环境的环境里验证全链路与回归检查。

### 回归矩阵（应包含）

- ✅ **功能正确性**（关键断言）
- ⚡ **性能**（响应时间 p95 / throughput）
- 💾 **资源**（内存/CPU）
- ❌ **错误率**（4xx/5xx）
- 📝 **日志完整性**（trace id / correlation）
- 📊 **覆盖率**（无新降低）
- 🔒 **安全**（依赖/配置无误）

### 负责人

**CI/CD 发布到 staging** → **SRE/QA 执行回归套件** → **报告生成**

### 验收标准

- ✅ 回归矩阵所有关键项 green 或在可接受偏差内（事先约定阈值）
- ❌ 若超出阈值，触发暂缓合并并进入修复 sprint

---

## 10. 📦 部署策略与保护（安全发布）

### 原则

渐进式部署 + 自动回滚 + 人工审批点

### 推荐做法

- 🐦 **Canary / Blue-Green 部署**
- 🔄 **自动健康检查与自动回滚**（阈值如 5xx > 1% 或 error rate 上升）
- 🗄️ **数据库迁移采用兼容的双写/蓝绿迁移策略**，避免一次性破坏性更改
- 📋 **部署前必须有已签署的 roll-back plan**

### 负责人

**Infra/DevOps Agent 执行**，**Owner 或 Release Manager 最终批准**（若高风险）

---

## 11. 📊 监控、告警与 SLO（上线后别放手）

### 必要监控维度

- 📈 **业务**：关键 KPI（转化/请求成功率）
- ⚡ **性能**：latency p50/p95/p99
- ❌ **错误**：5xx rate, error logs
- 💾 **资源**：CPU/memory/disk/io
- 🔒 **安全**：异常访问、secrets access

### 告警策略

- 🚨 **设定级别 P0/P1/P2** 并规定响应 SLA（例如 P0 15 分钟内响应）
- 🔄 **自动触发回滚条件**并通知团队

---

## 12. 🔍 回溯、经验汇编与知识回灌

### 目的

将每次变更的教训写成可复用知识，喂回训练/prompt/模板。

### 产出

- 📝 **变更日志 + Postmortem**（若发生 incident）
- 🐛 **失败样本集**（cause + fix）
- 📚 **更新的 design template / test template / prompt 模板**

### 负责人

**Owner 负责编写**（72 小时内草稿），**团队在 7 天内完成复盘**并分发

---

## 📋 实用模板

### PR 检查清单（合并前必须通过）

```markdown
## ✅ PR 检查清单

- [ ] 关联任务卡与目标明确
- [ ] CI green（lint/type/test/security）
- [ ] Unit tests 增量覆盖率 ≥ baseline（例如 >= 75%）
- [ ] 无高危依赖漏洞
- [ ] DB migration 有回滚计划
- [ ] 有回滚与监控计划
- [ ] Reviewers 签字（数量符合变更规模）
```

### 回归矩阵快速表（示例）

| 维度   | 断言            | 基线       | 实际  | 状态 |
| ------ | --------------- | ---------- | ----- | ---- |
| 功能   | 关键路径 10 条  | 100% 通过  | 10/10 | ✅   |
| 性能   | p95 响应时间    | <500ms     | 320ms | ✅   |
| 错误率 | 5xx 增长        | <0.5%      | +0.2% | ✅   |
| 资源   | 内存增长        | <10%       | +5%   | ✅   |
| 日志   | trace id 覆盖率 | 100%       | 100%  | ✅   |
| 安全   | 依赖漏洞        | critical=0 | 0     | ✅   |

### 安全检查强制项

```markdown
## 🔒 安全检查清单

- [ ] 所有外部输入均校验/转义
- [ ] 所有数据库操作使用参数化查询或 ORM 安全接口
- [ ] Secrets 已放入 Vault，不在代码/配置中明文
- [ ] 最小权限原则（服务账号权限审计）
```

---

## 🚧 常见堵点与工程对策（实操层面）

### 自动化测试问题

- **Flaky 测试** → 隔离标记，分析 root cause（race / timing），引入重试策略但不作为替代，长期修复

### 依赖管理

- **升级导致大量失败** → 采用依赖锁文件 + 定期升级窗口 + 影子分支先验证回归套件

### AI 生成代码

- **风格不统一** → CI 强制执行 formatter + pre-commit hooks

### 环境一致性

- **缺少复现环境** → 标准化 dev container/docker images 并在 CI 中复用同镜像

### 数据库迁移

- **风险高** → 采用无损迁移策略（添加列 → 双写 → 切流量 → 清理）

---

## 🎯 执行建议（三步立刻可做）

### 1. 接入自动化流程

把现有自动化接入 **第2+3+4步**：先从"骨架生成 + 分段生成 + 自动单测"做起，把每次生成的代码都必须伴随单元测试。

### 2. 启用 CI 质量门

强制 lint/type/test 在 PR 通过前必须 green。

### 3. 建立标准化流程

建立 PR 模板与回归矩阵（最少 5 条关键断言），并把合并权限与审批规则写入团队规则。

---

_📅 最后更新: 2025年11月5日_
_🎯 目标: 工业级软件开发质量保障_
_🏗️ 原则: 自动化 + 标准化 + 可重现_
