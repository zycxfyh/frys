name: ðŸ§ª Staging Deployment

on:
  push:
    branches: [ develop, staging ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'éƒ¨ç½²æ ‡ç­¾'
        required: false
        type: string

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  staging-deployment:
    name: 'ðŸš€ Staging éƒ¨ç½²æµæ°´çº¿'
    runs-on: ubuntu-latest
    environment: staging
    timeout-minutes: 25

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸ·ï¸ ç¡®å®šéƒ¨ç½²æ ‡ç­¾
      run: |
        if [ -n "${{ github.event.inputs.tag }}" ]; then
          echo "DEPLOY_TAG=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
        else
          echo "DEPLOY_TAG=${{ github.sha }}" >> $GITHUB_ENV
        fi
        echo "éƒ¨ç½²æ ‡ç­¾: $DEPLOY_TAG"

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    # 1ï¸âƒ£ æœ¬åœ°éªŒè¯é˜¶æ®µ
    - name: '1ï¸âƒ£ æœ¬åœ°éªŒè¯'
      run: |
        echo "å¼€å§‹æœ¬åœ°éªŒè¯..."
        node --version
        npm --version
        npm audit --audit-level=moderate
        echo "âœ… æœ¬åœ°éªŒè¯é€šè¿‡ (~2åˆ†é’Ÿ)"

    # 2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯•é˜¶æ®µ
    - name: '2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯•'
      run: |
        echo "å¼€å§‹è‡ªåŠ¨åŒ–æµ‹è¯•..."
        npm run lint
        npm run test:unit
        echo "âœ… è‡ªåŠ¨åŒ–æµ‹è¯•é€šè¿‡ (~5åˆ†é’Ÿ)"

    # 3ï¸âƒ£ å®‰å…¨æ£€æŸ¥é˜¶æ®µ
    - name: '3ï¸âƒ£ å®‰å…¨æ£€æŸ¥'
      run: |
        echo "å¼€å§‹å®‰å…¨æ£€æŸ¥..."
        node scripts/security-audit.js
        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ (~3åˆ†é’Ÿ)"

    # 4ï¸âƒ£ é›†æˆæµ‹è¯•é˜¶æ®µ
    - name: '4ï¸âƒ£ é›†æˆæµ‹è¯•'
      run: |
        echo "å¼€å§‹é›†æˆæµ‹è¯•..."
        npm run test:integration
        echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡ (~8åˆ†é’Ÿ)"

    # 5ï¸âƒ£ PRå®¡æ ¸é˜¶æ®µ (å¦‚æžœé€‚ç”¨)
    - name: '5ï¸âƒ£ PRå®¡æ ¸'
      if: github.event_name == 'pull_request'
      run: |
        echo "å¼€å§‹PRå®¡æ ¸..."
        node scripts/pr-check.js
        echo "âœ… PRå®¡æ ¸é€šè¿‡ (~2åˆ†é’Ÿ)"

    # 6ï¸âƒ£ Stagingéƒ¨ç½²é˜¶æ®µ
    - name: '6ï¸âƒ£ Stagingéƒ¨ç½²'
      run: |
        echo "å¼€å§‹Stagingéƒ¨ç½²..."
        docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-${{ env.DEPLOY_TAG }} .

        echo "æŽ¨é€é•œåƒåˆ°æ³¨å†Œè¡¨..."
        echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
        docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-${{ env.DEPLOY_TAG }}

        echo "éƒ¨ç½²åˆ°StagingçŽ¯å¢ƒ..."
        ./scripts/deploy.sh --env=staging --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-${{ env.DEPLOY_TAG }}
        echo "âœ… Stagingéƒ¨ç½²å®Œæˆ (~10åˆ†é’Ÿ)"

    # 7ï¸âƒ£ å›žå½’æµ‹è¯•é˜¶æ®µ
    - name: '7ï¸âƒ£ å›žå½’æµ‹è¯•'
      run: |
        echo "å¼€å§‹å›žå½’æµ‹è¯•..."
        sleep 30  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        node scripts/regression-matrix.js --env=staging
        echo "âœ… å›žå½’æµ‹è¯•é€šè¿‡ (~15åˆ†é’Ÿ)"

    # 8ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²é˜¶æ®µ (ä»…åœ¨mainåˆ†æ”¯ä¸”æ‰‹åŠ¨è§¦å‘æ—¶)
    - name: '8ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²'
      if: github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch'
      environment: production
      run: |
        echo "å¼€å§‹ç”Ÿäº§éƒ¨ç½²..."
        ./scripts/deploy.sh --env=production --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging-${{ env.DEPLOY_TAG }}
        echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ (~5åˆ†é’Ÿ)"

    # 9ï¸âƒ£ ç›‘æŽ§å›žæº¯é˜¶æ®µ
    - name: '9ï¸âƒ£ ç›‘æŽ§å›žæº¯'
      if: always()
      run: |
        echo "å¼€å§‹ç›‘æŽ§å›žæº¯..."
        node scripts/monitoring-rollback.js --check
        echo "âœ… ç›‘æŽ§å›žæº¯å®Œæˆ (æŒç»­ç›‘æŽ§)"

    # éƒ¨ç½²æŠ¥å‘Š
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      if: always()
      run: |
        echo "ç”ŸæˆStagingéƒ¨ç½²æŠ¥å‘Š..."
        cat > staging-deployment-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref }}",
          "environment": "staging",
          "status": "${{ job.status }}",
          "deploy_tag": "${{ env.DEPLOY_TAG }}",
          "pipeline_steps": [
            "æœ¬åœ°éªŒè¯ âœ…",
            "è‡ªåŠ¨åŒ–æµ‹è¯• âœ…",
            "å®‰å…¨æ£€æŸ¥ âœ…",
            "é›†æˆæµ‹è¯• âœ…",
            "PRå®¡æ ¸ âœ…",
            "Stagingéƒ¨ç½² âœ…",
            "å›žå½’æµ‹è¯• âœ…",
            "ç”Ÿäº§éƒ¨ç½² ${{ github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch' && 'âœ…' || 'â­ï¸' }}",
            "ç›‘æŽ§å›žæº¯ âœ…"
          ]
        }
        EOF

    - name: ðŸ“¤ ä¸Šä¼ éƒ¨ç½²æŠ¥å‘Š
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: staging-deployment-report
        path: staging-deployment-report.json

    - name: ðŸ’¬ éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
          const message = `${status} **frys Staging éƒ¨ç½²å®Œæˆ**

**æäº¤**: ${context.sha.substring(0, 7)}
**åˆ†æ”¯**: ${context.ref.replace('refs/heads/', '')}
**çŽ¯å¢ƒ**: Staging
**çŠ¶æ€**: ${{ job.status }}

éƒ¨ç½²è¯¦æƒ…: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

**æµæ°´çº¿æ­¥éª¤**:
1ï¸âƒ£ æœ¬åœ°éªŒè¯ âœ… é€šè¿‡ (~2åˆ†é’Ÿ)
2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯• âœ… é€šè¿‡ (~5åˆ†é’Ÿ)
3ï¸âƒ£ å®‰å…¨æ£€æŸ¥ âœ… é€šè¿‡ (~3åˆ†é’Ÿ)
4ï¸âƒ£ é›†æˆæµ‹è¯• âœ… é€šè¿‡ (~8åˆ†é’Ÿ)
5ï¸âƒ£ PRå®¡æ ¸ âœ… é€šè¿‡ (~2åˆ†é’Ÿ)
6ï¸âƒ£ Stagingéƒ¨ç½² âœ… é€šè¿‡ (~10åˆ†é’Ÿ)
7ï¸âƒ£ å›žå½’æµ‹è¯• âœ… é€šè¿‡ (~15åˆ†é’Ÿ)
8ï¸âƒ£ ç”Ÿäº§éƒ¨ç½² ${{ github.ref == 'refs/heads/main' && github.event_name == 'workflow_dispatch' && 'âœ… é€šè¿‡ (~5åˆ†é’Ÿ)' || 'â­ï¸ è·³è¿‡' }}
9ï¸âƒ£ ç›‘æŽ§å›žæº¯ âœ… æŒç»­ç›‘æŽ§`;

          if (context.issue) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
          }

          // å‘é€åˆ° Slack (å¦‚æžœé…ç½®äº†)
          if (process.env.SLACK_WEBHOOK_URL) {
            const slackMessage = {
              text: `frys Staging éƒ¨ç½² ${status}`,
              blocks: [
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: `${status} *frys Staging éƒ¨ç½²å®Œæˆ*\næäº¤: ${context.sha.substring(0, 7)}\nåˆ†æ”¯: ${context.ref.replace('refs/heads/', '')}\n<${context.payload.repository.html_url}/actions/runs/${context.runId}|æŸ¥çœ‹è¯¦æƒ…>`
                  }
                }
              ]
            };

            await fetch(process.env.SLACK_WEBHOOK_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(slackMessage)
            });
          }