name: ðŸš€ frys CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²çŽ¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # ç¼“å­˜ç­–ç•¥
  CACHE_KEY: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
  # å¹¶å‘æŽ§åˆ¶
  CONCURRENCY_GROUP: ${{ github.workflow }}-${{ github.ref }}
  CONCURRENCY_CANCEL_IN_PROGRESS: true

# å¹¶å‘æŽ§åˆ¶ - å–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # 1ï¸âƒ£ æœ¬åœ°éªŒè¯ - ä¾èµ–å®‰è£…å’ŒçŽ¯å¢ƒæ£€æŸ¥
  validate:
    name: '1ï¸âƒ£ æœ¬åœ°éªŒè¯'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ ç¼“å­˜ä¾èµ–
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
        key: ${{ env.CACHE_KEY }}
        restore-keys: |
          ${{ runner.os }}-node-

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        if [ "${{ steps.cache-deps.outputs.cache-hit }}" = "true" ]; then
          echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ä¾èµ–"
        else
          npm ci
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        fi

    - name: ðŸ” çŽ¯å¢ƒå’Œä¾èµ–æ£€æŸ¥
      run: |
        echo "Node.js ç‰ˆæœ¬: $(node --version)"
        echo "NPM ç‰ˆæœ¬: $(npm --version)"
        echo "é¡¹ç›®æ ¹ç›®å½•: $(pwd)"

        # æ£€æŸ¥å…³é”®æ–‡ä»¶å­˜åœ¨
        [ -f package.json ] || (echo "âŒ package.json ä¸å­˜åœ¨" && exit 1)
        [ -f src/index.js ] || (echo "âŒ ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨" && exit 1)
        [ -d src/ ] || (echo "âŒ src ç›®å½•ä¸å­˜åœ¨" && exit 1)
        [ -d tests/ ] || (echo "âŒ tests ç›®å½•ä¸å­˜åœ¨" && exit 1)

        # æ£€æŸ¥ä¾èµ–å®Œæ•´æ€§
        npm ls --depth=0 > /dev/null || (echo "âŒ ä¾èµ–ä¸å®Œæ•´" && exit 1)

        echo "âœ… çŽ¯å¢ƒå’Œä¾èµ–æ£€æŸ¥é€šè¿‡"

    - name: ðŸ“‹ é¡¹ç›®ç»“æž„éªŒè¯
      run: |
        echo "ðŸ“Š é¡¹ç›®ç»“æž„æ¦‚è§ˆ:"
        find . -maxdepth 2 -type f -name "*.js" -o -name "*.json" -o -name "*.md" | head -20
        echo ""
        echo "ðŸ“ˆ ä»£ç ç»Ÿè®¡:"
        echo "JavaScript æ–‡ä»¶: $(find src -name "*.js" | wc -l)"
        echo "æµ‹è¯•æ–‡ä»¶: $(find tests -name "*.test.js" | wc -l)"
        echo "é…ç½®å¤§å°: $(du -sh . | cut -f1)"
        echo "âœ… é¡¹ç›®ç»“æž„éªŒè¯å®Œæˆ"

  # 2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯• - çŸ©é˜µæµ‹è¯•ç­–ç•¥
  test:
    name: '2ï¸âƒ£ è‡ªåŠ¨åŒ–æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: validate
    strategy:
      matrix:
        test-type: [lint, unit, integration]
      fail-fast: false

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ” ESLint ä»£ç è´¨é‡æ£€æŸ¥
      if: matrix.test-type == 'lint'
      run: |
        echo "ðŸ” æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥..."
        npm run lint
        npm run format:check
        echo "âœ… ESLint å’Œæ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: ðŸ”§ è‡ªåŠ¨ä¿®å¤
      if: matrix.test-type == 'lint' && failure()
      run: |
        echo "ðŸ”§ å°è¯•è‡ªåŠ¨ä¿®å¤ä»£ç é—®é¢˜..."
        npm run fix:auto:ci
        echo "âœ… è‡ªåŠ¨ä¿®å¤å®Œæˆ"

    - name: ðŸ§ª å•å…ƒæµ‹è¯•
      if: matrix.test-type == 'unit'
      run: |
        echo "ðŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
        npm run test:ci:unit
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

    - name: ðŸ”— é›†æˆæµ‹è¯•
      if: matrix.test-type == 'integration'
      run: |
        echo "ðŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
        npm run test:ci:integration
        echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡"

    - name: ðŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šå’Œè¦†ç›–çŽ‡
      if: matrix.test-type == 'unit' || matrix.test-type == 'integration'
      run: |
        echo "ðŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
        npm run test:aggregate:ci
        echo "âœ… æµ‹è¯•èšåˆæŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ æµ‹è¯•äº§ç‰©
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test-type }}
        path: |
          test-results/
          coverage/
          reports/
        retention-days: 30

  # 3ï¸âƒ£ å®‰å…¨æ£€æŸ¥ - å…¨é¢å®‰å…¨æ‰«æ
  security:
    name: '3ï¸âƒ£ å®‰å…¨æ£€æŸ¥'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: validate
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ”’ GitHub ä»£ç æ‰«æ (CodeQL)
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        config-file: ./.github/codeql-config.yml

    - name: ðŸ” æ‰§è¡Œ CodeQL åˆ†æž
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

    - name: ðŸ”’ NPM å®‰å…¨å®¡è®¡
      run: |
        echo "ðŸ” æ‰§è¡ŒNPMå®‰å…¨å®¡è®¡..."
        npm audit --audit-level=moderate --json > npm-audit-results.json || true

        # æ£€æŸ¥å®¡è®¡ç»“æžœ
        if [ -f npm-audit-results.json ]; then
          VULNERABILITIES=$(cat npm-audit-results.json | jq '.metadata.vulnerabilities.total // 0')
          echo "å‘çŽ°å®‰å…¨æ¼æ´ž: $VULNERABILITIES"

          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "âš ï¸  å‘çŽ° $VULNERABILITIES ä¸ªå®‰å…¨æ¼æ´ž"
            cat npm-audit-results.json | jq '.vulnerabilities // {}' | head -50
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "åœ¨PRä¸­å…è®¸å®‰å…¨æ¼æ´žï¼Œä½†å»ºè®®ä¿®å¤"
            else
              exit 1
            fi
          else
            echo "âœ… NPM å®‰å…¨å®¡è®¡é€šè¿‡"
          fi
        fi

    - name: ðŸ›¡ï¸ å·¥ä¸šçº§å®‰å…¨æ‰«æ
      run: |
        echo "ðŸ›¡ï¸ æ‰§è¡Œå·¥ä¸šçº§å®‰å…¨æ‰«æ..."
        node scripts/security-audit.js --ci
        echo "âœ… å·¥ä¸šçº§å®‰å…¨æ‰«æå®Œæˆ"

    - name: ðŸ” ä¾èµ–æ£€æŸ¥ (Dependency Review)
      if: github.event_name == 'pull_request'
      uses: actions/dependency-review-action@v4
      with:
        config-file: ./.github/dependency-review-config.yml

    - name: ðŸ“‹ å®‰å…¨æŠ¥å‘Šæ±‡æ€»
      run: |
        echo "ðŸ“‹ ç”Ÿæˆå®‰å…¨æŠ¥å‘Š..."

        # æ±‡æ€»æ‰€æœ‰å®‰å…¨æ£€æŸ¥ç»“æžœ
        cat > security-summary.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref }}",
          "checks": {
            "codeql": "completed",
            "npm_audit": "completed",
            "industrial_scan": "completed",
            "dependency_review": "${{ github.event_name == 'pull_request' && 'completed' || 'skipped' }}"
          },
          "summary": "å®‰å…¨æ£€æŸ¥å®Œæˆï¼Œè¯¦ç»†ç»“æžœè¯·æŸ¥çœ‹å„æ­¥éª¤è¾“å‡º"
        }
        EOF

        echo "âœ… å®‰å…¨æ£€æŸ¥æ±‡æ€»å®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          security-audit-report.json
          npm-audit-results.json
          security-summary.json
        retention-days: 30

  # 4ï¸âƒ£ ç«¯åˆ°ç«¯æµ‹è¯• - ç”¨æˆ·ç•Œé¢å’ŒAPIæµ‹è¯•
  e2e:
    name: '4ï¸âƒ£ ç«¯åˆ°ç«¯æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [test, security]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ”— ç«¯åˆ°ç«¯æµ‹è¯•
      run: |
        echo "ðŸ”— æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
        npm run test:e2e:ci
        echo "âœ… ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡"

    - name: ðŸ“Š ç”ŸæˆE2Eæµ‹è¯•æŠ¥å‘Š
      run: |
        npm run test:report
        echo "âœ… E2Eæµ‹è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ E2Eæµ‹è¯•ç»“æžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # 5ï¸âƒ£ PRå®¡æ ¸ - è‡ªåŠ¨ä»£ç å®¡æŸ¥
  pr-review:
    name: '5ï¸âƒ£ PRå®¡æ ¸'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'pull_request'
    needs: [validate, test, security]
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ” PR è´¨é‡æ£€æŸ¥
      run: |
        echo "ðŸ” æ‰§è¡ŒPRè´¨é‡æ£€æŸ¥..."
        npm run pr:analyze:ci
        echo "âœ… PRè´¨é‡æ£€æŸ¥å®Œæˆ"

    - name: ðŸ“Š åˆ†æžæµ‹è¯•è¦†ç›–çŽ‡å˜åŒ–
      run: |
        echo "ðŸ“Š åˆ†æžæµ‹è¯•è¦†ç›–çŽ‡å˜åŒ–..."

        # èŽ·å–åŸºå‡†è¦†ç›–çŽ‡
        if [ -f coverage/coverage-summary.json ]; then
          CURRENT_COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "å½“å‰è¦†ç›–çŽ‡: ${CURRENT_COVERAGE}%"

          # è¿™é‡Œå¯ä»¥æ·»åŠ ä¸ŽåŸºå‡†åˆ†æ”¯çš„æ¯”è¾ƒé€»è¾‘
          echo "è¦†ç›–çŽ‡æ£€æŸ¥å®Œæˆ"
        fi

    - name: ðŸ“‹ ç”ŸæˆPRå®¡æŸ¥æŠ¥å‘Š
      run: |
        echo "ðŸ“‹ ç”ŸæˆPRå®¡æŸ¥æŠ¥å‘Š..."

        # æ”¶é›†æ‰€æœ‰æ£€æŸ¥ç»“æžœ
        VALIDATE_STATUS="${{ needs.validate.result }}"
        TEST_STATUS="${{ needs.test.result }}"
        SECURITY_STATUS="${{ needs.security.result }}"

        cat > pr-review-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "pr_number": ${{ github.event.pull_request.number }},
          "commit": "${{ github.sha }}",
          "author": "${{ github.event.pull_request.user.login }}",
          "branch": "${{ github.head_ref }}",
          "base_branch": "${{ github.base_ref }}",
          "checks": {
            "validate": {
              "status": "$VALIDATE_STATUS",
              "description": "æœ¬åœ°éªŒè¯å’Œä¾èµ–æ£€æŸ¥"
            },
            "test": {
              "status": "$TEST_STATUS",
              "description": "è‡ªåŠ¨åŒ–æµ‹è¯• (å•å…ƒ+é›†æˆ)"
            },
            "security": {
              "status": "$SECURITY_STATUS",
              "description": "å®‰å…¨æ‰«æå’Œå®¡è®¡"
            }
          },
          "summary": {
            "status": "$([ "$VALIDATE_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ] && [ "$SECURITY_STATUS" = "success" ] && echo "PASSED" || echo "FAILED")",
            "total_checks": 3,
            "passed_checks": $([ "$VALIDATE_STATUS" = "success" ] && echo 1 || echo 0)+$([ "$TEST_STATUS" = "success" ] && echo 1 || echo 0)+$([ "$SECURITY_STATUS" = "success" ] && echo 1 || echo 0),
            "failed_checks": $([ "$VALIDATE_STATUS" != "success" ] && echo 1 || echo 0)+$([ "$TEST_STATUS" != "success" ] && echo 1 || echo 0)+$([ "$SECURITY_STATUS" != "success" ] && echo 1 || echo 0)
          },
          "recommendations": [
            "ç¡®ä¿æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡",
            "æŸ¥çœ‹æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š",
            "ç¡®è®¤å®‰å…¨æ‰«æç»“æžœ",
            "è€ƒè™‘æ·»åŠ é›†æˆæµ‹è¯•",
            "æ£€æŸ¥æ€§èƒ½å½±å“"
          ]
        }
        EOF

        echo "âœ… PRå®¡æŸ¥æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ðŸ’¬ PR å®¡æŸ¥è¯„è®º
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('pr-review-report.json')) {
            const report = JSON.parse(fs.readFileSync('pr-review-report.json', 'utf8'));

            const statusEmoji = report.summary.status === 'PASSED' ? 'âœ…' : 'âŒ';
            const comment = `## ðŸ” è‡ªåŠ¨PRå®¡æŸ¥æŠ¥å‘Š

**çŠ¶æ€**: ${statusEmoji} **${report.summary.status}**

### ðŸ“Š æ£€æŸ¥ç»“æžœ

| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | æè¿° |
|---------|------|------|
| ðŸ” æœ¬åœ°éªŒè¯ | ${report.checks.validate.status === 'success' ? 'âœ…' : 'âŒ'} | ${report.checks.validate.description} |
| ðŸ§ª è‡ªåŠ¨åŒ–æµ‹è¯• | ${report.checks.test.status === 'success' ? 'âœ…' : 'âŒ'} | ${report.checks.test.description} |
| ðŸ”’ å®‰å…¨æ£€æŸ¥ | ${report.checks.security.status === 'success' ? 'âœ…' : 'âŒ'} | ${report.checks.security.description} |

### ðŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
- **æ€»æ£€æŸ¥æ•°**: ${report.summary.total_checks}
- **é€šè¿‡æ£€æŸ¥**: ${report.summary.passed_checks}
- **å¤±è´¥æ£€æŸ¥**: ${report.summary.failed_checks}

### ðŸ’¡ å»ºè®®
${report.recommendations.map(r => `- ${r}`).join('\n')}

---
*æ­¤æŠ¥å‘Šç”± frys CI/CD æµæ°´çº¿è‡ªåŠ¨ç”Ÿæˆ | [æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          }

  # 6ï¸âƒ£ æž„å»ºå’Œæ‰“åŒ…
  build:
    name: 'ðŸ—ï¸ æž„å»ºæ‰“åŒ…'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate, test, security, e2e]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ—ï¸ ç”Ÿäº§æž„å»º
      run: |
        echo "ðŸ—ï¸ å¼€å§‹ç”Ÿäº§æž„å»º..."
        npm run build:prod
        echo "âœ… ç”Ÿäº§æž„å»ºå®Œæˆ"

        # éªŒè¯æž„å»ºäº§ç‰©
        if [ -d dist ]; then
          echo "æž„å»ºäº§ç‰©å¤§å°: $(du -sh dist | cut -f1)"
          echo "æž„å»ºäº§ç‰©æ–‡ä»¶æ•°: $(find dist -type f | wc -l)"
        else
          echo "âŒ æž„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi

    - name: ðŸ³ è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ðŸ” ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ðŸ³ æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        labels: |
          org.opencontainers.image.title=${{ github.repository }}
          org.opencontainers.image.description=frys Production - ä¼ä¸šçº§å·¥ä½œæµç®¡ç†ç³»ç»Ÿ
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ github.sha }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}

    - name: ðŸ“‹ ç”Ÿæˆæž„å»ºæŠ¥å‘Š
      run: |
        echo "ðŸ“‹ ç”Ÿæˆæž„å»ºæŠ¥å‘Š..."
        cat > build-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref }}",
          "build": {
            "status": "success",
            "duration": "$(($(date +%s) - $(date -r dist +%s 2>/dev/null || echo $(date +%s))))",
            "artifacts": {
              "dist_size": "$(du -sh dist 2>/dev/null | cut -f1 || echo 'N/A')",
              "dist_files": "$(find dist -type f 2>/dev/null | wc -l || echo '0')",
              "docker_image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            }
          },
          "environment": {
            "node_version": "$(node --version)",
            "npm_version": "$(npm --version)",
            "docker_version": "$(docker --version)"
          }
        }
        EOF
        echo "âœ… æž„å»ºæŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}
        path: |
          dist/
          build-report.json
          docker-compose*.yml
          Dockerfile
        retention-days: 30

  # 7ï¸âƒ£ Staging éƒ¨ç½²éªŒè¯
  staging-validation:
    name: '6ï¸âƒ£ StagingéªŒè¯'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    environment: staging

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ” ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}

    - name: ðŸš€ Staging çŽ¯å¢ƒéƒ¨ç½²
      run: |
        echo "ðŸš€ å¼€å§‹StagingçŽ¯å¢ƒéƒ¨ç½²..."
        ./scripts/deploy.sh --env=staging --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        echo "âœ… Stagingéƒ¨ç½²å®Œæˆ"

    - name: ðŸ§ª éƒ¨ç½²å¥åº·æ£€æŸ¥
      run: |
        echo "ðŸ§ª æ‰§è¡Œéƒ¨ç½²å¥åº·æ£€æŸ¥..."
        node scripts/deployment-verification.js --env=staging --quick
        echo "âœ… Stagingéƒ¨ç½²éªŒè¯é€šè¿‡"

  # 8ï¸âƒ£ å›žå½’æµ‹è¯•çŸ©é˜µ
  regression-matrix:
    name: '7ï¸âƒ£ å›žå½’æµ‹è¯•'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: staging-validation
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ðŸ”„ æ‰§è¡Œå›žå½’æµ‹è¯•çŸ©é˜µ
      run: |
        echo "ðŸ”„ æ‰§è¡Œå›žå½’æµ‹è¯•çŸ©é˜µ..."
        node scripts/regression-matrix.js --env=staging --matrix
        echo "âœ… å›žå½’æµ‹è¯•çŸ©é˜µå®Œæˆ"

    - name: ðŸ“Š æ€§èƒ½åŸºå‡†å¯¹æ¯”
      run: |
        echo "ðŸ“Š æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        npm run benchmark -- --compare
        echo "âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ å›žå½’æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: regression-results-${{ github.sha }}
        path: |
          regression-test-results/
          benchmark-results/
          performance-comparison.json
        retention-days: 30

  # 9ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²
  production-deploy:
    name: '8ï¸âƒ£ ç”Ÿäº§éƒ¨ç½²'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build, regression-matrix]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ” ä¸‹è½½æž„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-${{ github.sha }}

    - name: ðŸš€ ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²
      run: |
        echo "ðŸš€ å¼€å§‹ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
        ./scripts/deploy.sh --env=production --image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        echo "âœ… ç”Ÿäº§éƒ¨ç½²å®Œæˆ"

    - name: ðŸ§ª ç”Ÿäº§çŽ¯å¢ƒéªŒè¯
      run: |
        echo "ðŸ§ª æ‰§è¡Œç”Ÿäº§çŽ¯å¢ƒéªŒè¯..."
        node scripts/deployment-verification.js --env=production
        echo "âœ… ç”Ÿäº§çŽ¯å¢ƒéªŒè¯é€šè¿‡"

    - name: ðŸ“Š SLO æ£€æŸ¥
      run: |
        echo "ðŸ“Š æ‰§è¡ŒæœåŠ¡æ°´å¹³ç›®æ ‡æ£€æŸ¥..."
        node scripts/slo-check.js --baseline
        echo "âœ… SLOæ£€æŸ¥å®Œæˆ"

  # ðŸ” éƒ¨ç½²ç›‘æŽ§ä¸Žå›žæº¯
  deployment-monitoring:
    name: '9ï¸âƒ£ éƒ¨ç½²ç›‘æŽ§'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [staging-validation, production-deploy]
    if: always()

    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ðŸ“Š æ”¶é›†éƒ¨ç½²ç›‘æŽ§æŒ‡æ ‡
      run: |
        echo "ðŸ“Š æ”¶é›†éƒ¨ç½²ç›‘æŽ§æŒ‡æ ‡..."
        node scripts/monitoring-rollback.js --check --comprehensive
        echo "âœ… ç›‘æŽ§æŒ‡æ ‡æ”¶é›†å®Œæˆ"

    - name: ðŸ“‹ ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "ðŸ“‹ ç”Ÿæˆå®Œæ•´éƒ¨ç½²æŠ¥å‘Š..."

        STAGING_STATUS="${{ needs.staging-validation.result }}"
        PRODUCTION_STATUS="${{ needs.production-deploy.result }}"

        cat > deployment-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref }}",
          "environments": {
            "staging": {
              "status": "$STAGING_STATUS",
              "deployed_at": "$(date -Iseconds)",
              "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            },
            "production": {
              "status": "$PRODUCTION_STATUS",
              "deployed_at": "$(date -Iseconds)",
              "image": "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
            }
          },
          "pipeline": {
            "status": "$([ "$STAGING_STATUS" = "success" ] && [ "$PRODUCTION_STATUS" = "success" ] && echo "success" || echo "partial")",
            "duration": "$(($(date +%s) - $(date -r .git +%s)))",
            "stages_completed": 9
          },
          "monitoring": {
            "enabled": true,
            "rollback_ready": true,
            "alerts_configured": true
          }
        }
        EOF

        echo "âœ… éƒ¨ç½²æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ðŸ“¤ ä¸Šä¼ éƒ¨ç½²ç›‘æŽ§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: deployment-report-${{ github.sha }}
        path: |
          deployment-report.json
          deployment-verification-*.json
          monitoring-*.log
          slo-baseline.json
        retention-days: 30

    - name: ðŸŽ¯ éƒ¨ç½²å®Œæˆé€šçŸ¥
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const stagingStatus = '${{ needs.staging-validation.result }}';
          const productionStatus = '${{ needs.production-deploy.result }}';

          const overallStatus = (stagingStatus === 'success' && productionStatus === 'success') ? 'âœ…' :
                               (stagingStatus === 'success' || productionStatus === 'success') ? 'âš ï¸' : 'âŒ';

          const message = `${overallStatus} **frys éƒ¨ç½²å®ŒæˆæŠ¥å‘Š**

**æäº¤**: \`${context.sha.substring(0, 7)}\`
**åˆ†æ”¯**: ${context.ref.replace('refs/heads/', '')}
**æ—¶é—´**: ${new Date().toISOString()}

### ðŸŒ çŽ¯å¢ƒéƒ¨ç½²çŠ¶æ€
- **Staging**: ${stagingStatus === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
- **Production**: ${productionStatus === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}

### ðŸ“Š æµæ°´çº¿æ¦‚è§ˆ
- **æ€»é˜¶æ®µ**: 9ä¸ª
- **æž„å»ºäº§ç‰©**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${context.sha.substring(0, 7)}
- **ç›‘æŽ§**: âœ… å·²å¯ç”¨
- **å›žæ»š**: âœ… å·²å‡†å¤‡

### ðŸ”— ç›¸å…³é“¾æŽ¥
- [ðŸ“‹ è¯¦ç»†éƒ¨ç½²æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
- [ðŸ“Š ç›‘æŽ§é¢æ¿](https://grafana.frys.com)
- [ðŸš¨ å‘Šè­¦ä¸­å¿ƒ](https://alertmanager.frys.com)

---
*è‡ªåŠ¨ç”Ÿæˆ by frys CI/CD Pipeline*`;

          if (context.issue) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
          }