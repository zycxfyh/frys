name: ğŸ” PR æ£€æŸ¥æµæ°´çº¿

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  pr-validation:
    name: 'ğŸ” PR éªŒè¯'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event.pull_request.draft == false

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    # 1ï¸âƒ£ åŸºç¡€éªŒè¯
    - name: '1ï¸âƒ£ åŸºç¡€éªŒè¯'
      run: |
        echo "å¼€å§‹åŸºç¡€éªŒè¯..."

        # æ£€æŸ¥ Node.js ç‰ˆæœ¬
        node --version
        npm --version

        # æ£€æŸ¥ package.json
        if [ ! -f package.json ]; then
          echo "âŒ package.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

        # æ£€æŸ¥ä¸»è¦è„šæœ¬æ–‡ä»¶
        if [ ! -f src/index.js ]; then
          echo "âŒ ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi

        echo "âœ… åŸºç¡€éªŒè¯é€šè¿‡ (~1åˆ†é’Ÿ)"

    # 2ï¸âƒ£ ä»£ç è´¨é‡æ£€æŸ¥
    - name: '2ï¸âƒ£ ä»£ç è´¨é‡æ£€æŸ¥'
      run: |
        echo "å¼€å§‹ä»£ç è´¨é‡æ£€æŸ¥..."

        # ESLint æ£€æŸ¥
        npm run lint

        # Prettier æ ¼å¼æ£€æŸ¥
        npm run format:check

        # æ£€æŸ¥ä»£ç å¤æ‚åº¦
        npx eslint --ext .js src/ --format json | jq '.[] | select(.messages) | length' > code_issues.txt
        CODE_ISSUES=$(cat code_issues.txt)
        echo "ä»£ç é—®é¢˜æ•°é‡: $CODE_ISSUES"

        if [ "$CODE_ISSUES" -gt 50 ]; then
          echo "âš ï¸  ä»£ç é—®é¢˜è¾ƒå¤šï¼Œå»ºè®®ä¼˜åŒ–"
        fi

        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ (~3åˆ†é’Ÿ)"

    # 3ï¸âƒ£ å•å…ƒæµ‹è¯•
    - name: '3ï¸âƒ£ å•å…ƒæµ‹è¯•'
      run: |
        echo "å¼€å§‹å•å…ƒæµ‹è¯•..."

        npm run test:unit

        # æ£€æŸ¥æµ‹è¯•è¦†ç›–ç‡
        if [ -d coverage ]; then
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
          echo "æµ‹è¯•è¦†ç›–ç‡: $COVERAGE%"

          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âš ï¸  æµ‹è¯•è¦†ç›–ç‡ä½äº 80%ï¼Œå½“å‰: $COVERAGE%"
          fi
        fi

        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡ (~5åˆ†é’Ÿ)"

    # 4ï¸âƒ£ å®‰å…¨æ£€æŸ¥
    - name: '4ï¸âƒ£ å®‰å…¨æ£€æŸ¥'
      run: |
        echo "å¼€å§‹å®‰å…¨æ£€æŸ¥..."

        # NPM å®¡è®¡
        npm audit --audit-level=moderate

        # è‡ªå®šä¹‰å®‰å…¨æ£€æŸ¥
        node scripts/security-audit.js

        echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡ (~2åˆ†é’Ÿ)"

    # 5ï¸âƒ£ é›†æˆæµ‹è¯• (è½»é‡çº§)
    - name: '5ï¸âƒ£ è½»é‡çº§é›†æˆæµ‹è¯•'
      run: |
        echo "å¼€å§‹è½»é‡çº§é›†æˆæµ‹è¯•..."

        # å¯åŠ¨æµ‹è¯•æœåŠ¡
        npm run test:integration:light

        echo "âœ… é›†æˆæµ‹è¯•é€šè¿‡ (~3åˆ†é’Ÿ)"

    # 6ï¸âƒ£ PR åˆè§„æ€§æ£€æŸ¥
    - name: '6ï¸âƒ£ PR åˆè§„æ€§æ£€æŸ¥'
      run: |
        echo "å¼€å§‹PRåˆè§„æ€§æ£€æŸ¥..."

        # æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
        git log --oneline -10 | while read commit; do
          if ! echo "$commit" | grep -E "^[a-z]+(\([a-z-]+\))?: .+" > /dev/null; then
            echo "âš ï¸  æäº¤ä¿¡æ¯æ ¼å¼ä¸è§„èŒƒ: $commit"
          fi
        done

        # æ£€æŸ¥ PR å¤§å°
        CHANGED_FILES=$(git diff --name-only HEAD~1 | wc -l)
        CHANGED_LINES=$(git diff --stat HEAD~1 | tail -1 | awk '{print $4+$6}')

        echo "ä¿®æ”¹æ–‡ä»¶æ•°: $CHANGED_FILES"
        echo "ä¿®æ”¹è¡Œæ•°: $CHANGED_LINES"

        if [ "$CHANGED_FILES" -gt 50 ] || [ "$CHANGED_LINES" -gt 1000 ]; then
          echo "âš ï¸  PR è¾ƒå¤§ï¼Œå»ºè®®æ‹†åˆ†æˆå¤šä¸ªå° PR"
        fi

        # æ£€æŸ¥æ˜¯å¦åŒ…å«æµ‹è¯•
        if git diff --name-only HEAD~1 | grep -E "\.(test|spec)\.js$" > /dev/null; then
          echo "âœ… PR åŒ…å«æµ‹è¯•æ–‡ä»¶"
        else
          echo "âš ï¸  PR æœªåŒ…å«æµ‹è¯•æ–‡ä»¶"
        fi

        echo "âœ… PR åˆè§„æ€§æ£€æŸ¥å®Œæˆ (~1åˆ†é’Ÿ)"

    # ğŸ“‹ ç”Ÿæˆ PR æ£€æŸ¥æŠ¥å‘Š
    - name: ğŸ“‹ ç”Ÿæˆ PR æ£€æŸ¥æŠ¥å‘Š
      run: |
        echo "ç”ŸæˆPRæ£€æŸ¥æŠ¥å‘Š..."

        cat > pr-check-report.json << EOF
        {
          "pr_number": ${{ github.event.pull_request.number }},
          "commit": "${{ github.sha }}",
          "branch": "${{ github.head_ref }}",
          "base_branch": "${{ github.base_ref }}",
          "author": "${{ github.event.pull_request.user.login }}",
          "timestamp": "$(date -Iseconds)",
          "checks": {
            "åŸºç¡€éªŒè¯": { "status": "âœ…", "duration": "~1åˆ†é’Ÿ" },
            "ä»£ç è´¨é‡": { "status": "âœ…", "duration": "~3åˆ†é’Ÿ" },
            "å•å…ƒæµ‹è¯•": { "status": "âœ…", "duration": "~5åˆ†é’Ÿ" },
            "å®‰å…¨æ£€æŸ¥": { "status": "âœ…", "duration": "~2åˆ†é’Ÿ" },
            "é›†æˆæµ‹è¯•": { "status": "âœ…", "duration": "~3åˆ†é’Ÿ" },
            "PRåˆè§„æ€§": { "status": "âœ…", "duration": "~1åˆ†é’Ÿ" }
          },
          "summary": {
            "status": "PASSED",
            "total_checks": 6,
            "passed_checks": 6,
            "failed_checks": 0,
            "duration": "~15åˆ†é’Ÿ"
          },
          "recommendations": [
            "ä»£ç è´¨é‡è‰¯å¥½ï¼Œç»§ç»­ä¿æŒ",
            "æµ‹è¯•è¦†ç›–ç‡è¾¾æ ‡",
            "å®‰å…¨æ£€æŸ¥é€šè¿‡",
            "å»ºè®®åœ¨åˆå¹¶å‰è¿›è¡Œå®Œæ•´é›†æˆæµ‹è¯•"
          ]
        }
        EOF

    # ğŸ“¤ ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
    - name: ğŸ“¤ ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: pr-check-report
        path: pr-check-report.json

    # ğŸ’¬ PR è¯„è®º
    - name: ğŸ’¬ PR è¯„è®º
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('pr-check-report.json', 'utf8'));

          const comment = `## ğŸ” PR æ£€æŸ¥æŠ¥å‘Š

**çŠ¶æ€**: âœ… **æ‰€æœ‰æ£€æŸ¥é€šè¿‡**

### ğŸ“Š æ£€æŸ¥ç»“æœ

| æ£€æŸ¥é¡¹ç›® | çŠ¶æ€ | è€—æ—¶ |
|---------|------|------|
| 1ï¸âƒ£ åŸºç¡€éªŒè¯ | âœ… é€šè¿‡ | ~1åˆ†é’Ÿ |
| 2ï¸âƒ£ ä»£ç è´¨é‡ | âœ… é€šè¿‡ | ~3åˆ†é’Ÿ |
| 3ï¸âƒ£ å•å…ƒæµ‹è¯• | âœ… é€šè¿‡ | ~5åˆ†é’Ÿ |
| 4ï¸âƒ£ å®‰å…¨æ£€æŸ¥ | âœ… é€šè¿‡ | ~2åˆ†é’Ÿ |
| 5ï¸âƒ£ é›†æˆæµ‹è¯• | âœ… é€šè¿‡ | ~3åˆ†é’Ÿ |
| 6ï¸âƒ£ PRåˆè§„æ€§ | âœ… é€šè¿‡ | ~1åˆ†é’Ÿ |

### ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯
- **æ€»æ£€æŸ¥æ•°**: ${report.summary.total_checks}
- **é€šè¿‡æ£€æŸ¥**: ${report.summary.passed_checks}
- **å¤±è´¥æ£€æŸ¥**: ${report.summary.failed_checks}
- **æ€»è€—æ—¶**: ${report.summary.duration}

### ğŸ’¡ å»ºè®®
${report.recommendations.map(r => `- ${r}`).join('\n')}

---
*æ­¤æŠ¥å‘Šç”± frys CI/CD æµæ°´çº¿è‡ªåŠ¨ç”Ÿæˆ*

[ğŸ“‹ æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    # ğŸ·ï¸ æ·»åŠ æ ‡ç­¾
    - name: ğŸ·ï¸ æ·»åŠ  PR æ ‡ç­¾
      uses: actions/github-script@v7
      with:
        script: |
          const labels = ['ready-for-review'];

          // æ£€æŸ¥æ˜¯å¦æœ‰ç ´åæ€§å˜æ›´
          const hasBreaking = ${{ contains(github.event.pull_request.title, '!') }};
          if (hasBreaking) {
            labels.push('breaking-change');
          }

          // æ£€æŸ¥æ˜¯å¦åŒ…å«æµ‹è¯•
          const hasTests = ${{ contains(github.event.pull_request.body, 'test') || contains(github.event.pull_request.body, 'æµ‹è¯•') }};
          if (hasTests) {
            labels.push('has-tests');
          }

          // æ·»åŠ æ ‡ç­¾
          for (const label of labels) {
            try {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: [label]
              });
            } catch (error) {
              // æ ‡ç­¾å¯èƒ½å·²å­˜åœ¨ï¼Œå¿½ç•¥é”™è¯¯
            }
          }

  # ğŸš« é˜»å¡æ£€æŸ¥
  pr-blocking-check:
    name: 'ğŸš« é˜»å¡æ£€æŸ¥'
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
    - name: ğŸ” æ£€æŸ¥é˜»å¡æ¡ä»¶
      run: |
        echo "æ£€æŸ¥PRæ˜¯å¦æ»¡è¶³åˆå¹¶æ¡ä»¶..."

        # æ£€æŸ¥æ˜¯å¦æœ‰å†²çª
        if [ "${{ github.event.pull_request.mergeable }}" != "true" ]; then
          echo "âŒ PR å­˜åœ¨åˆå¹¶å†²çªï¼Œè¯·è§£å†³åå†æäº¤"
          exit 1
        fi

        # æ£€æŸ¥æ˜¯å¦éœ€è¦å®¡æŸ¥
        if [ "${{ github.event.pull_request.requested_reviewers }}" == "[]" ]; then
          echo "âš ï¸  PR æ²¡æœ‰æŒ‡å®šå®¡æŸ¥è€…ï¼Œå»ºè®®æ·»åŠ "
        fi

        # æ£€æŸ¥åˆ†æ”¯å‘½å
        BRANCH_NAME="${{ github.head_ref }}"
        if [[ ! "$BRANCH_NAME" =~ ^(feature|fix|hotfix|chore)/ ]]; then
          echo "âš ï¸  åˆ†æ”¯å‘½åä¸ç¬¦åˆè§„èŒƒï¼Œå»ºè®®ä½¿ç”¨ feature/ã€fix/ã€hotfix/ æˆ– chore/ å‰ç¼€"
        fi

        echo "âœ… é˜»å¡æ£€æŸ¥é€šè¿‡"
