name: ğŸ“Š æµ‹è¯•æŠ¥å‘Šå‘å¸ƒ

on:
  workflow_run:
    workflows: ["ğŸš€ frys CI/CD Pipeline"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  test-report:
    name: 'ğŸ“Š ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š'
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
    - name: ğŸ“¥ ä¸‹è½½æµ‹è¯•äº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: test-results-unit
        path: test-results/

    - name: ğŸ“¥ ä¸‹è½½è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        name: test-results-integration
        path: test-results/

    - name: ğŸ“¥ ä¸‹è½½æ€§èƒ½æµ‹è¯•ç»“æœ
      uses: actions/download-artifact@v4
      with:
        name: test-results-performance
        path: test-results/

    - name: ğŸ“¥ ä¸‹è½½è¦†ç›–ç‡æ•°æ®
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: coverage/

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ“Š ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
      run: npm run test:report

    - name: ğŸ“¤ ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: |
          test-results/test-report.html
          test-results/summary.json
          test-results/coverage-report.json
          test-results/trends.json
          coverage/lcov-report/
        retention-days: 30

  # å‘å¸ƒåˆ° GitHub Pagesï¼ˆå¯é€‰ï¼‰
  publish-report:
    name: 'ğŸŒ å‘å¸ƒæŠ¥å‘Šåˆ° Pages'
    runs-on: ubuntu-latest
    needs: test-report
    if: github.ref == 'refs/heads/main' && github.event_name != 'workflow_dispatch'

    steps:
    - name: ğŸ“¥ ä¸‹è½½æŠ¥å‘Šäº§ç‰©
      uses: actions/download-artifact@v4
      with:
        name: test-report
        path: ./public

    - name: ğŸ—ï¸ è®¾ç½® Pages
      uses: actions/configure-pages@v4

    - name: ğŸ“¤ éƒ¨ç½²åˆ° Pages
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

  # ç”Ÿæˆæµ‹è¯•æ‘˜è¦æ³¨é‡Š
  test-summary:
    name: 'ğŸ’¬ æµ‹è¯•æ‘˜è¦'
    runs-on: ubuntu-latest
    needs: test-report
    if: github.event.workflow_run.event == 'pull_request'

    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‘˜è¦æŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        name: test-report
        path: ./reports

    - name: ğŸ“‹ è¯»å–æµ‹è¯•æ‘˜è¦
      id: summary
      run: |
        if [ -f reports/summary.json ]; then
          SUMMARY=$(cat reports/summary.json)
          echo "summary=$SUMMARY" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ’¬ è¯„è®ºæµ‹è¯•æ‘˜è¦
      if: steps.summary.outputs.summary
      uses: actions/github-script@v7
      with:
        script: |
          const summary = JSON.parse('${{ steps.summary.outputs.summary }}');
          const prNumber = ${{ github.event.workflow_run.pull_requests[0].number }};

          const comment = `## ğŸ§ª æµ‹è¯•æ‰§è¡Œæ‘˜è¦

**æ‰§è¡Œæ—¶é—´**: ${new Date(summary.timestamp).toLocaleString('zh-CN')}

### ğŸ“Š æµ‹è¯•ç»“æœ
- **æ€»æµ‹è¯•æ•°**: ${summary.tests}
- **é€šè¿‡**: ${summary.passed} âœ…
- **å¤±è´¥**: ${summary.failed} ${summary.failed > 0 ? 'âŒ' : 'âœ…'}
- **æ‰§è¡Œæ—¶é•¿**: ${(summary.duration / 1000).toFixed(1)}ç§’

### ğŸ“ˆ ä»£ç è¦†ç›–ç‡
- **è¡Œè¦†ç›–ç‡**: ${summary.coverage.lines?.pct || 0}%
- **å‡½æ•°è¦†ç›–ç‡**: ${summary.coverage.functions?.pct || 0}%
- **åˆ†æ”¯è¦†ç›–ç‡**: ${summary.coverage.branches?.pct || 0}%
- **è¯­å¥è¦†ç›–ç‡**: ${summary.coverage.statements?.pct || 0}%

### ğŸ”— è¯¦ç»†æŠ¥å‘Š
[æŸ¥çœ‹å®Œæ•´æµ‹è¯•æŠ¥å‘Š](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*æ­¤æŠ¥å‘Šç”± frys CI/CD æµæ°´çº¿è‡ªåŠ¨ç”Ÿæˆ*`;

          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
