name: ğŸš€ éƒ¨ç½²å·¥ä½œæµ

# ä»…åœ¨æ‰‹åŠ¨è§¦å‘æˆ–ç‰¹å®šæ¡ä»¶ä¸‹è¿è¡Œ
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      version:
        description: 'ç‰ˆæœ¬æ ‡ç­¾ (å¯é€‰)'
        required: false
        type: string
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½² (è·³è¿‡æŸäº›æ£€æŸ¥)'
        required: false
        type: boolean
        default: false

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # éƒ¨ç½²å‰éªŒè¯
  pre-deploy-validation:
    name: 'éƒ¨ç½²å‰éªŒè¯'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ” éƒ¨ç½²å‰æ£€æŸ¥
      id: validation
      run: |
        echo "æ‰§è¡Œéƒ¨ç½²å‰éªŒè¯..."

        # æ£€æŸ¥ä»£ç è´¨é‡
        if npm run lint -- --quiet --max-warnings=0; then
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥"
          if [ "${{ inputs.force_deploy }}" != "true" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

        # æ£€æŸ¥æµ‹è¯•
        if npm run test:smoke; then
          echo "âœ… å†’çƒŸæµ‹è¯•é€šè¿‡"
        else
          echo "âŒ å†’çƒŸæµ‹è¯•å¤±è´¥"
          if [ "${{ inputs.force_deploy }}" != "true" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        fi

        # æ£€æŸ¥æ„å»º
        if npm run build; then
          echo "âœ… æ„å»ºæˆåŠŸ"
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        echo "should_deploy=true" >> $GITHUB_OUTPUT

  # Staging éƒ¨ç½²
  deploy-staging:
    name: 'éƒ¨ç½²åˆ° Staging'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: inputs.environment == 'staging' && needs.pre-deploy-validation.outputs.should_deploy == 'true'
    needs: pre-deploy-validation
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ—ï¸ æ„å»ºåº”ç”¨
      run: npm run build:prod

    - name: ğŸ³ æ„å»º Docker é•œåƒ
      run: |
        docker build -t frys-staging:${{ github.sha }} .
        docker tag frys-staging:${{ github.sha }} frys-staging:latest

    - name: ğŸš€ éƒ¨ç½²åˆ° Staging
      id: deploy
      run: |
        echo "éƒ¨ç½²åˆ° staging ç¯å¢ƒ..."

        # è¿™é‡Œå¯ä»¥é›†æˆå®é™…çš„éƒ¨ç½²é€»è¾‘
        # ä¾‹å¦‚: Kubernetes, Docker Compose, AWS ç­‰

        # ç¤ºä¾‹: ä½¿ç”¨ docker-compose
        # docker-compose -f docker-compose.staging.yml up -d --build

        # è®¾ç½®éƒ¨ç½² URL
        echo "url=https://staging.frys.com" >> $GITHUB_OUTPUT

    - name: âœ… éƒ¨ç½²éªŒè¯
      run: node scripts/verify-deployment.js
      env:
        DEPLOY_ENV: staging
        DEPLOY_URL: ${{ steps.deploy.outputs.url }}

    - name: ğŸ“Š æ€§èƒ½åŸºå‡†
      run: node scripts/performance-benchmark.js --baseline

    - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
      run: |
        echo "âœ… Staging éƒ¨ç½²æˆåŠŸ"
        echo "ğŸŒ URL: ${{ steps.deploy.outputs.url }}"

  # Production éƒ¨ç½²
  deploy-production:
    name: 'éƒ¨ç½²åˆ° Production'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: inputs.environment == 'production' && needs.pre-deploy-validation.outputs.should_deploy == 'true'
    needs: pre-deploy-validation
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ› ï¸ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ—ï¸ ç”Ÿäº§æ„å»º
      run: npm run build:prod
      env:
        NODE_ENV: production

    - name: ğŸ³ æ„å»ºç”Ÿäº§é•œåƒ
      run: |
        docker build -t frys-production:${{ github.sha }} .
        docker tag frys-production:${{ github.sha }} frys-production:latest

    - name: ğŸš€ è“ç»¿éƒ¨ç½²åˆ° Production
      id: deploy
      run: |
        echo "æ‰§è¡Œè“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."

        # è¿™é‡Œè°ƒç”¨å®é™…çš„éƒ¨ç½²è„šæœ¬
        # ./scripts/deploy.sh --env production

        # è®¾ç½®éƒ¨ç½² URL
        echo "url=https://frys.com" >> $GITHUB_OUTPUT

    - name: âœ… éƒ¨ç½²åéªŒè¯
      run: node scripts/verify-deployment.js
      env:
        DEPLOY_ENV: production
        DEPLOY_URL: ${{ steps.deploy.outputs.url }}

    - name: ğŸ“Š éƒ¨ç½²æŒ‡æ ‡æ”¶é›†
      run: |
        echo "æ”¶é›†éƒ¨ç½²æŒ‡æ ‡..."
        # æ”¶é›†éƒ¨ç½²æ—¶é—´ã€æˆåŠŸç‡ç­‰æŒ‡æ ‡

    - name: ğŸ”„ å¯åŠ¨ç›‘æ§å›æ»š
      run: |
        echo "å¯åŠ¨æ™ºèƒ½ç›‘æ§å’Œå›æ»š..."
        # å¯åŠ¨ç›‘æ§è„šæœ¬åœ¨åå°è¿è¡Œ
        # nohup node scripts/smart-rollback.js monitor --env production &

    - name: ğŸ“¢ éƒ¨ç½²é€šçŸ¥
      run: |
        echo "ğŸ‰ ç”Ÿäº§éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ URL: ${{ steps.deploy.outputs.url }}"

  # éƒ¨ç½²åç›‘æ§
  post-deploy-monitoring:
    name: 'éƒ¨ç½²åç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.pre-deploy-validation.outputs.should_deploy == 'true'
    needs: [pre-deploy-validation, deploy-staging, deploy-production]

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: â±ï¸ è§‚å¯ŸæœŸç­‰å¾…
      run: |
        echo "ç­‰å¾…ç³»ç»Ÿç¨³å®š..."
        sleep 300  # 5åˆ†é’Ÿè§‚å¯ŸæœŸ

    - name: ğŸ“Š å¥åº·æ£€æŸ¥
      run: |
        ENV_URL="${{ inputs.environment == 'production' && secrets.PRODUCTION_URL || secrets.STAGING_URL }}"

        if curl -f "$ENV_URL/health" > /dev/null 2>&1; then
          echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          exit 1
        fi

    - name: ğŸ“ˆ æ€§èƒ½ç›‘æ§
      run: node scripts/performance-monitor.js --check --threshold 0.9
      env:
        DEPLOY_ENV: ${{ inputs.environment }}

    - name: ğŸ“¢ ç›‘æ§æŠ¥å‘Š
      run: |
        echo "## ğŸ“Š éƒ¨ç½²åç›‘æ§æŠ¥å‘Š" > monitoring-report.md
        echo "- ç¯å¢ƒ: ${{ inputs.environment }}" >> monitoring-report.md
        echo "- æ—¶é—´: $(date)" >> monitoring-report.md
        echo "- çŠ¶æ€: âœ… æ­£å¸¸" >> monitoring-report.md

    - name: ğŸ·ï¸ ä¸Šä¼ ç›‘æ§æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: post-deploy-monitoring-${{ inputs.environment }}
        path: monitoring-report.md
        retention-days: 7
