name: ğŸ” æµ‹è¯•åˆ†æä¸ä¼˜åŒ–

on:
  workflow_run:
    workflows: ["ğŸš€ frys CI/CD Pipeline"]
    types:
      - completed
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹è¿è¡Œä¸€æ¬¡è¶‹åŠ¿åˆ†æ
    - cron: '0 8 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  analyze-flaky-tests:
    name: 'ğŸ”„ åˆ†æä¸ç¨³å®šæµ‹è¯•'
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ“Š åˆ†ææµ‹è¯•ç¨³å®šæ€§
      run: |
        echo "åˆ†ææµ‹è¯•ç¨³å®šæ€§..."
        npm run test:flaky > flaky-analysis.log 2>&1 || true

        # ç»Ÿè®¡å¤±è´¥ç‡
        if [ -f test-results/test-results.json ]; then
          FAILED_TESTS=$(cat test-results/test-results.json | jq '.testResults[] | select(.status == "failed") | .assertionResults[] | select(.status == "failed") | .title' | wc -l)
          TOTAL_TESTS=$(cat test-results/test-results.json | jq '.testResults[] | .assertionResults | length' | awk '{sum += $1} END {print sum}')

          if [ "$TOTAL_TESTS" -gt 0 ]; then
            FAILURE_RATE=$((FAILED_TESTS * 100 / TOTAL_TESTS))
            echo "æµ‹è¯•å¤±è´¥ç‡: $FAILURE_RATE%"

            if [ "$FAILURE_RATE" -gt 5 ]; then
              echo "âš ï¸  æµ‹è¯•å¤±è´¥ç‡è¿‡é«˜ï¼Œéœ€è¦ä¼˜åŒ–" >> flaky-analysis.log
            fi
          fi
        fi

    - name: ğŸ“‹ ç”Ÿæˆä¸ç¨³å®šæµ‹è¯•æŠ¥å‘Š
      run: |
        cat > flaky-tests-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "analysis": "flaky-tests",
          "recommendations": [
            "è€ƒè™‘å¢åŠ æµ‹è¯•é‡è¯•æ¬¡æ•°",
            "æ£€æŸ¥å¼‚æ­¥æ“ä½œçš„ç­‰å¾…æ—¶é—´",
            "éªŒè¯æµ‹è¯•æ•°æ®çš„ä¸€è‡´æ€§",
            "è€ƒè™‘ä½¿ç”¨æ›´ç¨³å®šçš„æµ‹è¯•ç¯å¢ƒ"
          ]
        }
        EOF

    - name: ğŸ“¤ ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: flaky-analysis
        path: |
          flaky-analysis.log
          flaky-tests-report.json

  test-performance-analysis:
    name: 'âš¡ æ€§èƒ½æµ‹è¯•åˆ†æ'
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ§ª è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        npm run test:performance:ci
        npm run benchmark

    - name: ğŸ“Š åˆ†ææ€§èƒ½è¶‹åŠ¿
      run: |
        echo "åˆ†ææ€§èƒ½è¶‹åŠ¿..."

        # æ£€æŸ¥æ˜¯å¦æœ‰æ€§èƒ½å›å½’
        if [ -f test-results/performance-results.json ]; then
          CURRENT_AVG=$(cat test-results/performance-results.json | jq '.averageResponseTime')
          PREVIOUS_AVG=$(cat test-results/trends.json | jq '.[-2].performance.averageResponseTime // 1000')

          if (( $(echo "$CURRENT_AVG > $PREVIOUS_AVG * 1.1" | bc -l) )); then
            echo "âš ï¸  æ€§èƒ½å›å½’æ£€æµ‹: å“åº”æ—¶é—´å¢åŠ è¶…è¿‡10%" >> performance-analysis.log
          fi
        fi

    - name: ğŸ“‹ ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
      run: |
        cat > performance-analysis-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "analysis": "performance-trends",
          "metrics": {
            "response_time_trend": "stable",
            "memory_usage_trend": "stable",
            "throughput_trend": "stable"
          },
          "recommendations": [
            "ç›‘æ§å“åº”æ—¶é—´è¶‹åŠ¿",
            "å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µ",
            "å…³æ³¨ååé‡å˜åŒ–"
          ]
        }
        EOF

    - name: ğŸ“¤ ä¸Šä¼ æ€§èƒ½åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: performance-analysis
        path: |
          performance-analysis.log
          performance-analysis-report.json
          test-results/performance-results.json

  coverage-analysis:
    name: 'ğŸ“Š è¦†ç›–ç‡æ·±åº¦åˆ†æ'
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ§ª ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: npm run test:coverage

    - name: ğŸ” åˆ†æè¦†ç›–ç‡å·®è·
      run: |
        echo "åˆ†æè¦†ç›–ç‡å·®è·..."

        if [ -f coverage/coverage-summary.json ]; then
          # æ£€æŸ¥æœªè¦†ç›–çš„ä»£ç è¡Œ
          LOW_COVERAGE_FILES=$(cat coverage/coverage-summary.json | jq -r 'to_entries[] | select(.value.lines.pct < 80) | .key')

          echo "è¦†ç›–ç‡ä½äº80%çš„æ–‡ä»¶:" > coverage-gaps.log
          echo "$LOW_COVERAGE_FILES" >> coverage-gaps.log

          # ç”Ÿæˆæ”¹è¿›å»ºè®®
          echo "æ”¹è¿›å»ºè®®:" >> coverage-gaps.log
          echo "1. ä¸ºæœªè¦†ç›–çš„åˆ†æ”¯æ·»åŠ æµ‹è¯•ç”¨ä¾‹" >> coverage-gaps.log
          echo "2. å®¡æŸ¥é”™è¯¯å¤„ç†ä»£ç çš„è¦†ç›–æƒ…å†µ" >> coverage-gaps.log
          echo "3. æ£€æŸ¥è¾¹ç•Œæ¡ä»¶çš„æµ‹è¯•è¦†ç›–" >> coverage-gaps.log
        fi

    - name: ğŸ“‹ ç”Ÿæˆè¦†ç›–ç‡åˆ†ææŠ¥å‘Š
      run: |
        cat > coverage-analysis-report.json << EOF
        {
          "timestamp": "$(date -Iseconds)",
          "analysis": "coverage-gaps",
          "findings": {
            "low_coverage_files": $(cat coverage/coverage-summary.json | jq '[to_entries[] | select(.value.lines.pct < 80) | .key]'),
            "uncovered_branches": $(cat coverage/coverage-summary.json | jq '[to_entries[] | select(.value.branches.pct < 80) | .key]'),
            "uncovered_functions": $(cat coverage/coverage-summary.json | jq '[to_entries[] | select(.value.functions.pct < 80) | .key]')
          },
          "recommendations": [
            "ä¼˜å…ˆä¸ºæ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ·»åŠ æµ‹è¯•",
            "å…³æ³¨é”™è¯¯å¤„ç†è·¯å¾„çš„è¦†ç›–",
            "æ·»åŠ é›†æˆæµ‹è¯•ä»¥æé«˜è¦†ç›–ç‡",
            "è€ƒè™‘ä½¿ç”¨TDDæ–¹æ³•ç¼–å†™æ–°åŠŸèƒ½"
          ]
        }
        EOF

    - name: ğŸ“¤ ä¸Šä¼ è¦†ç›–ç‡åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-analysis
        path: |
          coverage-gaps.log
          coverage-analysis-report.json
          coverage/

  create-improvement-issues:
    name: 'ğŸ“‹ åˆ›å»ºæ”¹è¿›ä»»åŠ¡'
    runs-on: ubuntu-latest
    needs: [analyze-flaky-tests, test-performance-analysis, coverage-analysis]
    if: github.event.schedule || github.event_name == 'workflow_dispatch'

    steps:
    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰åˆ†ææŠ¥å‘Š
      uses: actions/download-artifact@v4
      with:
        path: ./analysis-reports

    - name: ğŸ” åˆ†æå¹¶åˆ›å»ºæ”¹è¿›ä»»åŠ¡
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // è¯»å–åˆ†ææŠ¥å‘Š
          const reports = {
            flaky: path.join('analysis-reports', 'flaky-analysis', 'flaky-tests-report.json'),
            performance: path.join('analysis-reports', 'performance-analysis', 'performance-analysis-report.json'),
            coverage: path.join('analysis-reports', 'coverage-analysis', 'coverage-analysis-report.json')
          };

          let issuesCreated = 0;

          // åˆ›å»ºä¸ç¨³å®šæµ‹è¯•æ”¹è¿›ä»»åŠ¡
          if (fs.existsSync(reports.flaky)) {
            const flakyReport = JSON.parse(fs.readFileSync(reports.flaky, 'utf8'));

            const body = `## ğŸ”„ æµ‹è¯•ç¨³å®šæ€§æ”¹è¿›

**åˆ†ææ—¶é—´**: ${flakyReport.timestamp}

### ğŸ¯ é—®é¢˜æè¿°
æ£€æµ‹åˆ°æµ‹è¯•è¿è¡Œå­˜åœ¨ä¸ç¨³å®šæ€§ï¼Œå¯èƒ½çš„åŸå› ï¼š
- å¼‚æ­¥æ“ä½œç­‰å¾…æ—¶é—´ä¸å……è¶³
- æµ‹è¯•æ•°æ®çŠ¶æ€ä¸ä¸€è‡´
- å¤–éƒ¨ä¾èµ–ä¸ç¨³å®š
- å¹¶å‘æµ‹è¯•ç›¸äº’å¹²æ‰°

### âœ… å»ºè®®æ”¹è¿›æªæ–½
${flakyReport.recommendations.map(r => `- [ ] ${r}`).join('\n')}

### ğŸ“Š ç›¸å…³æ–‡ä»¶
- æµ‹è¯•æ–‡ä»¶: \`tests/\`
- CIé…ç½®: \`.github/workflows/ci.yml\`

---
*æ­¤ä»»åŠ¡ç”±è‡ªåŠ¨åŒ–æµ‹è¯•åˆ†ææµæ°´çº¿ç”Ÿæˆ*`;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ”„ æ”¹è¿›æµ‹è¯•ç¨³å®šæ€§',
                body: body,
                labels: ['testing', 'improvement', 'automation']
              });
              issuesCreated++;
              console.log(`åˆ›å»ºæµ‹è¯•ç¨³å®šæ€§æ”¹è¿›ä»»åŠ¡: #${issue.data.number}`);
            } catch (error) {
              console.log('æµ‹è¯•ç¨³å®šæ€§ä»»åŠ¡å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥');
            }
          }

          // åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ä»»åŠ¡
          if (fs.existsSync(reports.performance)) {
            const perfReport = JSON.parse(fs.readFileSync(reports.performance, 'utf8'));

            const body = `## âš¡ æ€§èƒ½æµ‹è¯•ä¼˜åŒ–

**åˆ†ææ—¶é—´**: ${perfReport.timestamp}

### ğŸ“ˆ å½“å‰çŠ¶æ€
- å“åº”æ—¶é—´è¶‹åŠ¿: ${perfReport.metrics.response_time_trend}
- å†…å­˜ä½¿ç”¨è¶‹åŠ¿: ${perfReport.metrics.memory_usage_trend}
- ååé‡è¶‹åŠ¿: ${perfReport.metrics.throughput_trend}

### âœ… ä¼˜åŒ–å»ºè®®
${perfReport.recommendations.map(r => `- [ ] ${r}`).join('\n')}

### ğŸ“Š ç›¸å…³æ–‡ä»¶
- æ€§èƒ½æµ‹è¯•: \`tests/performance/\`
- åŸºå‡†æµ‹è¯•: \`scripts/benchmark.js\`

---
*æ­¤ä»»åŠ¡ç”±è‡ªåŠ¨åŒ–æµ‹è¯•åˆ†ææµæ°´çº¿ç”Ÿæˆ*`;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš¡ ä¼˜åŒ–æµ‹è¯•æ€§èƒ½',
                body: body,
                labels: ['testing', 'performance', 'improvement', 'automation']
              });
              issuesCreated++;
              console.log(`åˆ›å»ºæ€§èƒ½ä¼˜åŒ–ä»»åŠ¡: #${issue.data.number}`);
            } catch (error) {
              console.log('æ€§èƒ½ä¼˜åŒ–ä»»åŠ¡å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥');
            }
          }

          // åˆ›å»ºè¦†ç›–ç‡æ”¹è¿›ä»»åŠ¡
          if (fs.existsSync(reports.coverage)) {
            const covReport = JSON.parse(fs.readFileSync(reports.coverage, 'utf8'));

            const lowCoverageFiles = covReport.findings.low_coverage_files || [];
            const uncoveredBranches = covReport.findings.uncovered_branches || [];
            const uncoveredFunctions = covReport.findings.uncovered_functions || [];

            const body = `## ğŸ“Š æå‡æµ‹è¯•è¦†ç›–ç‡

**åˆ†ææ—¶é—´**: ${covReport.timestamp}

### ğŸ“ˆ è¦†ç›–ç‡ç»Ÿè®¡
- ä½è¦†ç›–ç‡æ–‡ä»¶æ•°é‡: ${lowCoverageFiles.length}
- æœªè¦†ç›–åˆ†æ”¯æ–‡ä»¶æ•°é‡: ${uncoveredBranches.length}
- æœªè¦†ç›–å‡½æ•°æ–‡ä»¶æ•°é‡: ${uncoveredFunctions.length}

### ğŸ¯ ä¼˜å…ˆæ”¹è¿›æ–‡ä»¶
${lowCoverageFiles.slice(0, 10).map(f => `- [ ] \`${f}\``).join('\n')}

### âœ… æ”¹è¿›ç­–ç•¥
${covReport.recommendations.map(r => `- [ ] ${r}`).join('\n')}

### ğŸ“Š ç›¸å…³æ–‡ä»¶
- è¦†ç›–ç‡æŠ¥å‘Š: \`coverage/\`
- æµ‹è¯•æ–‡ä»¶: \`tests/\`

---
*æ­¤ä»»åŠ¡ç”±è‡ªåŠ¨åŒ–æµ‹è¯•åˆ†ææµæ°´çº¿ç”Ÿæˆ*`;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“Š æå‡æµ‹è¯•è¦†ç›–ç‡',
                body: body,
                labels: ['testing', 'coverage', 'improvement', 'automation']
              });
              issuesCreated++;
              console.log(`åˆ›å»ºè¦†ç›–ç‡æ”¹è¿›ä»»åŠ¡: #${issue.data.number}`);
            } catch (error) {
              console.log('è¦†ç›–ç‡æ”¹è¿›ä»»åŠ¡å·²å­˜åœ¨æˆ–åˆ›å»ºå¤±è´¥');
            }
          }

          console.log(`âœ… å…±åˆ›å»ºäº† ${issuesCreated} ä¸ªæ”¹è¿›ä»»åŠ¡`);
