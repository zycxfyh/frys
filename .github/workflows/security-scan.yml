name: ğŸ”’ å®‰å…¨æ‰«æ

# å®‰å…¨æ‰«æè§¦å‘æ¡ä»¶
on:
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'SECURITY.md'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'package.json'
      - 'package-lock.json'
      - 'SECURITY.md'
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹è¿›è¡Œå®šæœŸå®‰å…¨æ‰«æ
    - cron: '0 9 * * 1'
  workflow_dispatch:

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '18'

jobs:
  # ä¾èµ–å®‰å…¨æ‰«æ
  dependency-scan:
    name: 'ä¾èµ–å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” npm å®¡è®¡
        run: npm audit --audit-level moderate
        continue-on-error: true

      - name: ğŸ›¡ï¸ Snyk å®‰å…¨æ‰«æ
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      - name: ğŸ”’ OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'frys'
          path: '.'
          format: 'ALL'
          args: >
            --enableRetired
            --enableExperimental
            --nvdValidForHours 24

      - name: ğŸ·ï¸ ä¸Šä¼ ä¾èµ–æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: |
            reports/
            dependency-check-report.html
          retention-days: 30

  # ä»£ç å®‰å…¨æ‰«æ
  code-security-scan:
    name: 'ä»£ç å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” CodeQL åˆå§‹åŒ–
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          config-file: ./.github/codeql-config.yml

      - name: ğŸš€ æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v3
        with:
          category: '/language:javascript'

      - name: ğŸ›¡ï¸ Semgrep å®‰å…¨æ‰«æ
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/security-audit
          output: semgrep-results.json
        env:
          SEMGREP_RULES: p/security-audit
        continue-on-error: true

      - name: ğŸ” ESLint å®‰å…¨è§„åˆ™
        run: npx eslint src/ --ext .js --config .eslintrc.security.js
        continue-on-error: true

      - name: ğŸ·ï¸ ä¸Šä¼ ä»£ç å®‰å…¨æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-security-scan-results
          path: |
            semgrep-results.json
            codeql-results.sarif
          retention-days: 30

  # å®¹å™¨å®‰å…¨æ‰«æ
  container-security-scan:
    name: 'å®¹å™¨å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ³ æ„å»º Docker é•œåƒ
        run: docker build -t frys-security-scan:${{ github.sha }} .

      - name: ğŸ” Trivy æ¼æ´æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'image'
          scan-ref: 'frys-security-scan:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: ğŸ›¡ï¸ Dockle æœ€ä½³å®è·µæ£€æŸ¥
        uses: goodwithtech/dockle-action@v1
        with:
          image: 'frys-security-scan:${{ github.sha }}'
          format: 'sarif'
          output: 'dockle-results.sarif'
        continue-on-error: true

      - name: ğŸ”’ Hadolint Dockerfile æ£€æŸ¥
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
          format: sarif
          output-file: hadolint-results.sarif
        continue-on-error: true

      - name: ğŸ·ï¸ ä¸Šä¼ å®¹å™¨å®‰å…¨æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: container-security-scan-results
          path: |
            trivy-results.sarif
            dockle-results.sarif
            hadolint-results.sarif
          retention-days: 30

  # åŸºç¡€è®¾æ–½å®‰å…¨æ‰«æ
  infrastructure-security-scan:
    name: 'åŸºç¡€è®¾æ–½å®‰å…¨æ‰«æ'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ” Checkov IaC æ‰«æ
        uses: bridgecrewio/checkov-action@v12
        with:
          framework: dockerfile
          output_format: sarif
          output_file_path: checkov-results.sarif
        continue-on-error: true

      - name: ğŸ›¡ï¸ KICS åŸºç¡€è®¾æ–½æ‰«æ
        uses: Checkmarx/kics-github-action@v2.0.2
        with:
          path: '.'
          output_formats: 'sarif'
          output_path: 'kics-results.sarif'
        continue-on-error: true

      - name: ğŸ·ï¸ ä¸Šä¼ åŸºç¡€è®¾æ–½å®‰å…¨æ‰«æç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: infrastructure-security-scan-results
          path: |
            checkov-results.sarif
            kics-results.sarif
          retention-days: 30

  # å®‰å…¨å®¡è®¡æŠ¥å‘Šç”Ÿæˆ
  security-audit-report:
    name: 'å®‰å…¨å®¡è®¡æŠ¥å‘Š'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs:
      [
        dependency-scan,
        code-security-scan,
        container-security-scan,
        infrastructure-security-scan,
      ]
    if: always()

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ“Š ç”Ÿæˆç»¼åˆå®‰å…¨æŠ¥å‘Š
        run: node scripts/security-audit.js --ci --comprehensive
        env:
          CI: true

      - name: ğŸ“‹ å®‰å…¨çŠ¶æ€æ±‡æ€»
        run: |
          echo "# ğŸ”’ å®‰å…¨æ‰«ææŠ¥å‘Š" > security-summary.md
          echo "" >> security-summary.md
          echo "## æ‰«ææ—¶é—´" >> security-summary.md
          echo "$(date)" >> security-summary.md
          echo "" >> security-summary.md
          echo "## æ‰«æç»“æœ" >> security-summary.md

          # æ£€æŸ¥æ˜¯å¦æœ‰é«˜å±æ¼æ´
          if [ -f "security-audit-report.json" ]; then
            high_vulns=$(jq '.summary.highSeverity' security-audit-report.json 2>/dev/null || echo "0")
            if [ "$high_vulns" -gt 0 ]; then
              echo "âŒ å‘ç° $high_vulns ä¸ªé«˜å±å®‰å…¨é—®é¢˜" >> security-summary.md
              echo "::error::å‘ç° $high_vulns ä¸ªé«˜å±å®‰å…¨é—®é¢˜"
            else
              echo "âœ… æœªå‘ç°é«˜å±å®‰å…¨é—®é¢˜" >> security-summary.md
            fi
          fi

          echo "" >> security-summary.md
          echo "## è¯¦ç»†æŠ¥å‘Š" >> security-summary.md
          echo "è¯·æŸ¥çœ‹é™„ä»¶ä¸­çš„è¯¦ç»†å®‰å…¨æ‰«æç»“æœã€‚" >> security-summary.md

      - name: ğŸ·ï¸ ä¸Šä¼ å®‰å…¨å®¡è®¡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: |
            security-audit-report.json
            security-summary.md
            reports/
          retention-days: 90

      - name: ğŸš¨ å®‰å…¨è­¦æŠ¥ (é«˜å±æ¼æ´)
        if: failure()
        run: |
          echo "ğŸš¨ æ£€æµ‹åˆ°ä¸¥é‡å®‰å…¨é—®é¢˜ï¼"
          echo "è¯·ç«‹å³å¤„ç†å®‰å…¨æ¼æ´ã€‚"
          # è¿™é‡Œå¯ä»¥å‘é€é€šçŸ¥åˆ°å®‰å…¨å›¢é˜Ÿ
