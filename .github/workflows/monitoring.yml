name: ğŸ” éƒ¨ç½²ç›‘æ§ä¸å›æº¯

on:
  deployment_status
  schedule:
    # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ç”Ÿäº§ç¯å¢ƒçŠ¶æ€
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»å‹'
        required: true
        default: 'comprehensive'
        type: choice
        options:
        - health
        - performance
        - security
        - comprehensive

env:
  NODE_VERSION: '18'

jobs:
  health-monitoring:
    name: 'ğŸ¥ å¥åº·ç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event.deployment_status.state == 'success'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ¥ å¥åº·æ£€æŸ¥
      run: |
        echo "ğŸ¥ æ‰§è¡Œç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."

        # æ£€æŸ¥Stagingç¯å¢ƒ
        echo "æ£€æŸ¥Stagingç¯å¢ƒ..."
        curl -f -s --max-time 30 https://staging.frys.com/health || echo "âš ï¸  Stagingç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"

        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ
        echo "æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒ..."
        curl -f -s --max-time 30 https://frys.com/health || echo "âš ï¸  ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥å¤±è´¥"

        # è®°å½•å¥åº·çŠ¶æ€
        echo "âœ… å¥åº·æ£€æŸ¥å®Œæˆ"

  performance-monitoring:
    name: 'ğŸ“Š æ€§èƒ½ç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'performance') || (github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'comprehensive')

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ“Š æ€§èƒ½åŸºå‡†æµ‹è¯•
      run: |
        echo "ğŸ“Š æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
        npm run benchmark -- --env=production --quiet
        echo "âœ… æ€§èƒ½åŸºå‡†æµ‹è¯•å®Œæˆ"

    - name: ğŸ“ˆ SLO æ£€æŸ¥
      run: |
        echo "ğŸ“ˆ æ‰§è¡ŒæœåŠ¡æ°´å¹³ç›®æ ‡æ£€æŸ¥..."
        node scripts/slo-check.js --baseline --quiet
        echo "âœ… SLOæ£€æŸ¥å®Œæˆ"

  security-monitoring:
    name: 'ğŸ”’ å®‰å…¨ç›‘æ§'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'security') || (github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'comprehensive')

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸŸ¢ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      run: npm ci

    - name: ğŸ”’ å®‰å…¨å®¡è®¡
      run: |
        echo "ğŸ”’ æ‰§è¡Œå®‰å…¨å®¡è®¡..."
        npm audit --audit-level=moderate --json > security-audit.json || true
        echo "âœ… å®‰å…¨å®¡è®¡å®Œæˆ"

    - name: ğŸ›¡ï¸ è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥
      run: |
        echo "ğŸ›¡ï¸ æ‰§è¡Œè¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥..."
        node scripts/security-audit.js --runtime --quiet
        echo "âœ… è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥å®Œæˆ"

  alert-management:
    name: 'ğŸš¨ å‘Šè­¦ç®¡ç†'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [health-monitoring, performance-monitoring, security-monitoring]
    if: always()

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸš¨ æ£€æŸ¥å‘Šè­¦æ¡ä»¶
      run: |
        echo "ğŸš¨ æ£€æŸ¥ç›‘æ§å‘Šè­¦æ¡ä»¶..."

        # æ”¶é›†ç›‘æ§ç»“æœ
        HEALTH_STATUS="${{ needs.health-monitoring.result }}"
        PERF_STATUS="${{ needs.performance-monitoring.result }}"
        SEC_STATUS="${{ needs.security-monitoring.result }}"

        echo "å¥åº·ç›‘æ§çŠ¶æ€: $HEALTH_STATUS"
        echo "æ€§èƒ½ç›‘æ§çŠ¶æ€: $PERF_STATUS"
        echo "å®‰å…¨ç›‘æ§çŠ¶æ€: $SEC_STATUS"

        # ç”Ÿæˆå‘Šè­¦æ‘˜è¦
        ALERTS=""
        if [ "$HEALTH_STATUS" != "success" ]; then
          ALERTS="${ALERTS}\nğŸš¨ å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        if [ "$PERF_STATUS" != "success" ]; then
          ALERTS="${ALERTS}\nâš ï¸  æ€§èƒ½æ£€æŸ¥å¤±è´¥"
        fi
        if [ "$SEC_STATUS" != "success" ]; then
          ALERTS="${ALERTS}\nğŸ”´ å®‰å…¨æ£€æŸ¥å¤±è´¥"
        fi

        if [ -n "$ALERTS" ]; then
          echo "å‘ç°å‘Šè­¦:$ALERTS"
          echo "alerts=$ALERTS" >> $GITHUB_ENV
        else
          echo "âœ… æ‰€æœ‰ç›‘æ§æ£€æŸ¥é€šè¿‡"
        fi

    - name: ğŸ“¢ å‘é€å‘Šè­¦é€šçŸ¥
      if: env.alerts != ''
      uses: actions/github-script@v7
      with:
        script: |
          const alerts = process.env.alerts;
          const message = `ğŸš¨ **frys ç›‘æ§å‘Šè­¦**

**æ—¶é—´**: ${new Date().toISOString()}
**è§¦å‘**: å®šæ—¶ç›‘æ§æ£€æŸ¥

**å‘Šè­¦è¯¦æƒ…**:
${alerts.split('\\n').filter(a => a).map(alert => `- ${alert}`).join('\\n')}

[ğŸ“Š æŸ¥çœ‹ç›‘æ§è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*è‡ªåŠ¨ç›‘æ§ç³»ç»Ÿ*`;

          // åˆ›å»ºIssueé€šçŸ¥
          github.rest.issues.create({
            issue_number: 1, // æˆ–ä½¿ç”¨ç‰¹å®šçš„ç›‘æ§issueç¼–å·
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `ğŸš¨ ç›‘æ§å‘Šè­¦ - ${new Date().toISOString()}`,
            body: message,
            labels: ['monitoring', 'alert']
          });

  rollback-readiness:
    name: 'ğŸ”„ å›æ»šå‡†å¤‡'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: alert-management
    if: needs.alert-management.result == 'failure'

    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ğŸ”„ å‡†å¤‡å›æ»šç­–ç•¥
      run: |
        echo "ğŸ”„ æ£€æµ‹åˆ°ç›‘æ§å¤±è´¥ï¼Œå‡†å¤‡å›æ»šç­–ç•¥..."

        # ç”Ÿæˆå›æ»šè®¡åˆ’
        node scripts/smart-rollback.js --plan --env=production
        echo "âœ… å›æ»šè®¡åˆ’å·²ç”Ÿæˆ"

    - name: ğŸ“‹ å›æ»šé€šçŸ¥
      uses: actions/github-script@v7
      with:
        script: |
          const message = `ğŸ”„ **å›æ»šå‡†å¤‡å°±ç»ª**

ç”±äºç›‘æ§æ£€æŸ¥å¤±è´¥ï¼Œç³»ç»Ÿå·²è‡ªåŠ¨å‡†å¤‡å›æ»šç­–ç•¥ã€‚

**å»ºè®®æ“ä½œ**:
1. æ£€æŸ¥å¤±è´¥çš„å…·ä½“åŸå› 
2. è¯„ä¼°æ˜¯å¦éœ€è¦ç«‹å³å›æ»š
3. å¦‚æœéœ€è¦å›æ»šï¼Œæ‰§è¡Œ: \`./scripts/smart-rollback.js --rollback\`

[ğŸ“‹ æŸ¥çœ‹å›æ»šè®¡åˆ’](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

---
*æ™ºèƒ½å›æ»šç³»ç»Ÿ*`;

          github.rest.issues.createComment({
            issue_number: 1, // ä½¿ç”¨ç›‘æ§issue
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: message
          });
